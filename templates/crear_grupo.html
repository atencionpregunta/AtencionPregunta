{% extends "base.html" %}
{% set body_class = 'app-shell tone-soft page-grupos' %}
{% block title %}Crear Grupo · Reto Diario{% endblock %}

{% block content %}
  <!-- Header -->
  <header class="flex items-center justify-between mb-4">
    <a href="{{ url_for('index') }}"
       class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-rose-100 bg-white hover:bg-neutral-50 text-sm">
      <i class="fa-solid fa-arrow-left"></i> Volver
    </a>
    <h2 class="text-xl sm:text-2xl font-extrabold text-brand">
      <i class="fa-solid fa-users-gear"></i> Crear grupo
    </h2>
  </header>

  <!-- Flashes -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2 mb-4">
        {% for category, message in messages %}
          {% set cls = 'bg-emerald-50 text-emerald-800 border-emerald-200' if category=='success'
                      else ('bg-red-50 text-red-800 border-red-200' if category in ['error','danger']
                      else 'bg-blue-50 text-blue-800 border-blue-200') %}
          <div class="px-4 py-2 rounded-xl border {{ cls }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Form -->
  <form
    id="form-crear-grupo"
    method="POST"
    action="{{ url_for('grupos.crear_grupo') }}"
    novalidate
    x-data="crearGrupo()"
    x-init="init()"
    @submit.prevent="onSubmit"
    class="space-y-4"
  >
    <!-- Nombre -->
    <div>
      <label for="nombre_grupo" class="block font-semibold text-sm mb-1">Nombre del grupo</label>
      <input
        id="nombre_grupo"
        name="nombre_grupo"
        type="text"
        required
        autocomplete="off"
        x-model.trim="nombre"
        @input.debounce.350ms="checkNombre"
        class="w-full h-11 px-4 rounded-full border border-rose-100 bg-white shadow-sm focus:outline-none focus:ring-4 focus:ring-rose-300"
        placeholder="p. ej. Reto_Mates_Lunes"
        value="{{ request.form.get('nombre_grupo','') }}"
      >
      <div class="text-sm mt-1"
           :class="hintNombre.kind==='ok' ? 'text-emerald-600' : hintNombre.kind==='bad' ? 'text-red-600' : 'text-neutral-600'"
           x-text="hintNombre.text">
      </div>
    </div>

    <!-- Tipo -->
    <div>
      <label for="tipo_grupo" class="block font-semibold text-sm mb-1">Tipo de grupo</label>
      <select id="tipo_grupo" name="tipo_grupo" required
              x-model="tipo"
              class="w-full h-11 px-4 rounded-full border border-rose-100 bg-white shadow-sm focus:outline-none focus:ring-4 focus:ring-rose-300">
        <option value="publico" {% if request.form.get('tipo_grupo','publico')=='publico' %}selected{% endif %}>Público</option>
        <option value="privado" {% if request.form.get('tipo_grupo')=='privado' %}selected{% endif %}>Privado</option>
      </select>
    </div>

    <!-- Contraseña (solo si es privado) -->
    <template x-if="tipo==='privado'">
      <div>
        <label for="contrasena_grupo" class="block font-semibold text-sm mb-1">Contraseña</label>
        <div class="relative" x-data="{show:false}">
          <input :type="show ? 'text' : 'password'"
                 id="contrasena_grupo"
                 name="contrasena_grupo"
                 minlength="3"
                 :required="tipo==='privado'"
                 class="w-full h-11 pl-4 pr-11 rounded-full border border-rose-100 bg-white shadow-sm focus:outline-none focus:ring-4 focus:ring-rose-300"
                 placeholder="mínimo 3 caracteres">
          <button type="button" @click="show=!show"
                  class="absolute inset-y-0 right-0 px-3 text-neutral-600 hover:text-neutral-900"
                  aria-label="Mostrar u ocultar contraseña">
            <i class="fa-solid" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
          </button>
        </div>
        <div class="text-sm mt-1 text-neutral-600">Requerida si el grupo es privado.</div>
      </div>
    </template>

    <!-- Duración (siempre requerida) -->
    <div>
      <label for="duracion_dias" class="block font-semibold text-sm mb-1">Duración (días)</label>
      <input id="duracion_dias" name="duracion_dias" type="number" inputmode="numeric"
             min="1" max="365" step="1" required
             x-model.number="duracion"
             class="w-full h-11 px-4 rounded-full border border-rose-100 bg-white shadow-sm focus:outline-none focus:ring-4 focus:ring-rose-300"
             placeholder="p. ej., 30"
             value="{{ request.form.get('duracion_dias','') }}">
      <div class="text-sm mt-1"
           :class="hintDuracion.kind==='bad' ? 'text-red-600' : 'text-neutral-600'"
           x-text="hintDuracion.text">
      </div>
    </div>

    <!-- Acciones -->
    <div class="grid gap-2 sm:grid-cols-[1fr_auto] mt-2">
      <button type="submit"
              :disabled="!canSubmit"
              class="inline-flex items-center justify-center gap-2 px-5 h-11 rounded-full text-white
                     bg-gradient-to-tr from-brand to-brand-dark shadow-md hover:shadow-lg transition
                     disabled:opacity-50 disabled:cursor-not-allowed">
        <i class="fa-solid fa-plus"></i> Crear grupo
      </button>
      <a href="{{ url_for('grupos.gestionar_grupos') }}"
         class="inline-flex items-center justify-center gap-2 px-4 h-11 rounded-full border border-rose-100 bg-white hover:bg-neutral-50">
        <i class="fa-solid fa-gear"></i> Gestionar grupos
      </a>
    </div>
  </form>

  {% if grupos_usuario %}
    <div class="mt-5">
      <h3 class="font-extrabold text-brand mb-2">Tus grupos actuales</h3>
      <ul class="bg-white border border-rose-100 rounded-2xl divide-y divide-rose-100">
        {% for grupo in grupos_usuario %}
          <li class="px-4 py-2 flex items-center gap-2">
            <i class="fa-solid fa-users text-neutral-500"></i>
            <span class="truncate">{{ grupo.codigo }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
function crearGrupo(){
  // Helpers
  const emailLike = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // (no se usa aquí, queda por si amplías)
  const nombreRegex = /^[\p{L}\p{N}\s_.-]{3,40}$/u;
  const CHECK_URL = "{{ url_for('grupos.check_nombre') }}";

  const debounce = (fn, ms=350) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

  return {
    // Estado
    nombre: "{{ request.form.get('nombre_grupo','') }}",
    tipo: "{{ request.form.get('tipo_grupo','publico') or 'publico' }}",
    duracion: Number("{{ request.form.get('duracion_dias','') }}") || null,

    hintNombre: { kind: 'neutral', text: 'Escribe un nombre de grupo.' },
    hintDuracion: { kind: 'neutral', text: 'Entre 1 y 365 días. Será la duración de cada temporada.' },

    canSubmit: false,

    init(){
      // Validación inicial
      this.validateNombreLocal();
      this.validateDuracion();
      this.updateCanSubmit();
    },

    updateCanSubmit(){
      const nombreOk = this.hintNombre.kind === 'ok';
      const durOk = this.hintDuracion.kind !== 'bad';
      const passOk = this.tipo === 'publico' ? true : true; // el input required se encarga en HTML
      this.canSubmit = nombreOk && durOk && passOk;
    },

    setNombreHint(kind, text){ this.hintNombre = {kind, text}; this.updateCanSubmit(); },
    setDuracionHint(kind, text){ this.hintDuracion = {kind, text}; this.updateCanSubmit(); },

    validateNombreLocal(){
      const v = (this.nombre || '').replace(/\s+/g,' ').trim();
      this.nombre = v;
      if(!v){ this.setNombreHint('neutral','Escribe un nombre de grupo.'); return false; }
      if(!nombreRegex.test(v)){
        this.setNombreHint('bad','Entre 3 y 40 caracteres. Letras/números/espacios/._-');
        return false;
      }
      this.setNombreHint('neutral','Comprobando disponibilidad…');
      return true;
    },

    checkNombre: debounce(async function(){
      if(!this.validateNombreLocal()) return;
      const q = this.nombre;
      try{
        const url = new URL(CHECK_URL, window.location.origin);
        url.searchParams.set('q', q);
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' }, cache: 'no-store' });
        if(!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        if((this.nombre||'') !== q) return; // desincronización
        if(data && data.exists){
          this.setNombreHint('bad','Ya existe un grupo con ese nombre.');
        } else {
          this.setNombreHint('ok','Disponible ✔');
        }
      } catch {
        // Si no se puede comprobar, permitimos submit y que el servidor valide
        this.setNombreHint('neutral','No se pudo comprobar ahora; se validará al enviar.');
      }
    }, 350),

    validateDuracion(){
      const n = Number(this.duracion);
      if(!Number.isFinite(n) || n < 1 || n > 365){
        this.setDuracionHint('bad','La duración debe ser un número entre 1 y 365.');
        return false;
      }
      this.setDuracionHint('neutral','Entre 1 y 365 días. Será la duración de cada temporada.');
      return true;
    },

    async onSubmit(e){
      // Validaciones finales en cliente (suave)
      const okNombre = this.validateNombreLocal();
      const okDur = this.validateDuracion();
      if(!okNombre || !okDur){ return; }

      // Comprobación de última hora del nombre (para evitar carreras)
      try{
        const url = new URL(CHECK_URL, window.location.origin);
        url.searchParams.set('q', this.nombre);
        const resp = await fetch(url, { headers: { 'Accept': 'application/json' }, cache: 'no-store' });
        const data = await resp.json();
        if(data && data.exists){ this.setNombreHint('bad','Ya existe un grupo con ese nombre.'); return; }
      } catch { /* continúa, el servidor valida */ }

      // Spinner en botón
      const btn = document.querySelector('#form-crear-grupo button[type="submit"]');
      if(btn){
        btn.insertAdjacentHTML('beforeend','<span class="ml-2 inline-block w-4 h-4 border-2 border-white border-r-transparent rounded-full animate-spin"></span>');
      }

      // Enviar
      e.target.submit();
    }
  }
}
</script>
{% endblock %}
