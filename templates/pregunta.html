{% extends "base.html" %}
{% set body_class = 'app-shell tone-soft page-pregunta' %}
{% block title %}Pregunta del día · Reto Diario{% endblock %}

{% block content %}
<div
  class="max-w-3xl mx-auto"
  x-data="quiz({
    total: {{ tiempo_segundos|default(30) }},
    timeoutUrl: '{{ url_for('preguntas.timeout', pregunta_id=pregunta['id']) }}',
    multiple: {{ 'true' if es_multiple else 'false' }}
  })"
  x-init="start()"
>

  <!-- Header + chips -->
  <div class="flex items-center justify-between flex-wrap gap-3 mb-3">
    <h1 class="text-xl sm:text-2xl font-extrabold text-brand">❓ Pregunta del día</h1>
    <div class="flex items-center gap-2 flex-wrap">
      <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-rose-100 bg-white text-sm font-extrabold">
        {% if es_multiple %}
          <i class="fa-solid fa-layer-group"></i> Respuesta múltiple
        {% else %}
          <i class="fa-solid fa-dot-circle"></i> Respuesta única
        {% endif %}
      </span>
      <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-rose-100 bg-white text-sm font-extrabold">
        <i class="fa-solid fa-clock"></i>
        <span x-text="seconds"></span>s
      </span>
      {% if is_pack_domingo|default(false) %}
      <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-rose-100 bg-white text-sm font-extrabold" title="Pack relámpago">
        <i class="fa-solid fa-bolt"></i>
        Relámpago {{ (pack_idx|default(0)) + 1 }}/{{ pack_total|default(3) }}
      </span>
      {% endif %}
    </div>
  </div>

  <!-- Audio opcional -->
  {% if ruta_audio %}
  <div class="flex items-center gap-2 mb-3">
    <button id="play-audio" type="button"
            class="inline-flex items-center gap-2 px-3 h-10 rounded-full border border-rose-100 bg-white hover:bg-neutral-50 text-sm">
      ▶ Escuchar audio
    </button>
    <audio id="player" preload="auto" hidden>
      <source src="{{ url_for('static', filename=ruta_audio) }}" type="audio/mpeg">
      Tu navegador no soporta el audio.
    </audio>
  </div>
  {% endif %}

  <!-- Imagen opcional -->
  {% if ruta_imagen %}
  <div class="mb-3">
    <img class="rounded-2xl shadow-lg w-full" src="{{ url_for('static', filename=ruta_imagen) }}" alt="Imagen de la pregunta">
  </div>
  {% endif %}

  <!-- Enunciado -->
  <h2 class="text-lg sm:text-xl font-semibold text-neutral-900 mb-2">{{ pregunta["pregunta"] }}</h2>

  <!-- Formulario -->
  <form id="form-pregunta"
        method="POST"
        action="{{ url_for('preguntas.ver_pregunta') }}"
        @submit.prevent="validateBeforeSend($event) && $el.submit()">

    <input type="hidden" name="pregunta_id" value="{{ pregunta['id'] }}">

    <!-- Opciones -->
    <div role="group" aria-label="Respuestas" class="space-y-2">
      {% if es_multiple %}
        <p class="text-sm text-neutral-600">Marca todas las correctas (pueden ser varias).</p>
        {% for r in respuestas %}
        <label class="flex items-start gap-3 p-3 rounded-xl border border-rose-100 bg-white hover:bg-neutral-50">
          <input type="checkbox"
                 class="mt-1"
                 name="respuestas_seleccionadas[]"
                 value="{{ r['id'] }}"
                 :disabled="submitted || seconds<=0"
                 aria-label="{{ r['respuesta'] }}">
          <div class="leading-snug">{{ r['respuesta'] }}</div>
        </label>
        {% endfor %}
      {% else %}
        <p class="text-sm text-neutral-600">Elige una única respuesta.</p>
        {% for r in respuestas %}
        <label class="flex items-start gap-3 p-3 rounded-xl border border-rose-100 bg-white hover:bg-neutral-50">
          <input type="radio"
                 class="mt-1"
                 name="respuesta"
                 value="{{ r['id'] }}"
                 required
                 :disabled="submitted || seconds<=0"
                 aria-label="{{ r['respuesta'] }}">
          <div class="leading-snug">{{ r['respuesta'] }}</div>
        </label>
        {% endfor %}
      {% endif %}
    </div>

    <!-- Botón enviar (separado de la última opción) -->
    <div class="mt-6">
      <button type="submit"
              :disabled="submitted || seconds<=0"
              class="w-full inline-flex items-center justify-center gap-2 px-5 h-12 rounded-xl text-white
                     bg-gradient-to-tr from-brand to-brand-dark shadow-md hover:shadow-lg transition
                     disabled:opacity-50 disabled:cursor-not-allowed">
        {% if is_pack_domingo|default(false) %}
          <i class="fa-solid fa-bolt"></i> {{ btn_label|default('Enviar y terminar') }}
        {% else %}
          <i class="fa-solid fa-paper-plane"></i> {{ btn_label|default('Enviar respuesta') }}
        {% endif %}
      </button>
    </div>

    <!-- TIMER DELUXE -->
    <div class="mt-4 flex flex-col items-center select-none">
      <svg viewBox="0 0 120 120" width="96" height="96" class="block">
        <defs>
          <linearGradient id="timerGrad" x1="0" y1="0" x2="1" y2="1">
            <stop :offset="0" :stop-color="gradFrom"></stop>
            <stop :offset="1" :stop-color="gradTo"></stop>
          </linearGradient>
          <filter id="softGlow" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="3" result="b"/>
            <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
          <g id="tick">
            <line x1="60" y1="8" x2="60" y2="14" stroke="#e5e7eb" stroke-width="2" stroke-linecap="round"/>
          </g>
        </defs>

        <!-- pista -->
        <circle cx="60" cy="60" r="48" fill="none" stroke="#f1f5f9" stroke-width="10"/>

        <!-- ticks -->
        <g>
          <template x-for="i in tickCount" :key="i">
            <use href="#tick" :transform="`rotate(${(360/tickCount)*i} 60 60)`"></use>
          </template>
        </g>

        <!-- progreso -->
        <circle cx="60" cy="60" r="48" fill="none"
                :stroke="`url(#timerGrad)`"
                stroke-width="10"
                stroke-linecap="round"
                :stroke-dasharray="circumference"
                :stroke-dashoffset="dash"
                style="transform: rotate(-90deg); transform-origin: 60px 60px; transition: stroke-dashoffset .15s linear;"
                filter="url(#softGlow)">
        </circle>

        <!-- “punta” -->
        <circle r="6" :cx="capX" :cy="capY" :fill="gradTo" filter="url(#softGlow)"></circle>

        <!-- número -->
        <text x="60" y="65" text-anchor="middle" font-size="24" font-weight="800" fill="#111"
              aria-live="polite" x-text="seconds"></text>
      </svg>
      <div class="text-xs text-neutral-600 mt-1">Tiempo restante</div>
    </div>

    <!-- Resultado (si lo inyectas luego) -->
    <div id="resultado" class="text-center text-sm font-semibold"></div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
/* ======= Timer deluxe + estado (Alpine v3) ======= */
function quiz({ total=30, timeoutUrl, multiple=false }) {
  return {
    // ---- estado base ----
    total,
    seconds: total,
    submitted: false,

    // ---- dibujo deluxe ----
    r: 48,
    get circumference(){ return 2 * Math.PI * this.r; },
    dash: 0,
    gradFrom: '#16a34a', // verde
    gradTo:   '#22c55e',
    tickCount: Math.max(6, Math.round(this.total / 5)), // ~marca cada 5s
    get progress(){ return Math.max(0, Math.min(1, this.seconds / this.total)); },
    get capAngle(){ return (1 - this.progress) * 2 * Math.PI - Math.PI/2; }, // -90°
    get capX(){ return 60 + this.r * Math.cos(this.capAngle); },
    get capY(){ return 60 + this.r * Math.sin(this.capAngle); },

    // ---- inicio ----
    start(){
      const deadline = Date.now() + this.total * 1000;
      const loop = () => {
        const msLeft = Math.max(0, deadline - Date.now());
        this.seconds = Math.ceil(msLeft / 1000);
        this.updateVisuals(msLeft);

        // vibración a 10/5/3 s si se puede
        if ([10,5,3].includes(this.seconds)) {
          try { navigator.vibrate?.(100); } catch(_) {}
        }

        if (msLeft <= 0) {
          // timeout → redirige (o auto-submit si prefieres)
          window.location.replace(timeoutUrl);
          return;
        }
        requestAnimationFrame(loop);
      };
      requestAnimationFrame(loop);
    },

    updateVisuals(msLeft){
      // color (verde → ámbar → rojo)
      if(this.seconds <= 5)      { this.gradFrom = '#ef4444'; this.gradTo = '#dc2626'; }
      else if(this.seconds <=10) { this.gradFrom = '#f59e0b'; this.gradTo = '#d97706'; }
      else                       { this.gradFrom = '#16a34a'; this.gradTo = '#22c55e'; }

      // dashoffset: cuánto “comido” del perímetro
      this.dash = this.circumference * (1 - this.progress);
    },

    // ---- envío ----
    validateBeforeSend(e){
      if(this.submitted) return false;

      if (multiple) {
        const any = e.target.querySelector('input[name="respuestas_seleccionadas[]"]:checked');
        if(!any){
          window.toast?.('Selecciona al menos una respuesta','bad');
          return false;
        }
      }
      const btn = e.target.querySelector('button[type="submit"]');
      if(btn && !btn.querySelector('.spin')){
        btn.insertAdjacentHTML('beforeend','<span class="spin ml-2 inline-block w-4 h-4 border-2 border-white border-r-transparent rounded-full animate-spin"></span>');
      }
      this.submitted = true;
      return true;
    }
  }
}

/* ======= Audio preview corto (si existe) ======= */
(function(){
  const player = document.getElementById('player');
  const btn = document.getElementById('play-audio');
  if(!player || !btn) return;
  const LIMIT = 5; // s
  btn.addEventListener('click', () => {
    try { player.currentTime = 0; player.play(); } catch(_) {}
    btn.disabled = true;
  });
  player.addEventListener('timeupdate', () => {
    if (player.currentTime >= LIMIT) {
      player.pause(); player.currentTime = 0; btn.disabled = false;
    }
  });
  player.addEventListener('ended', () => { btn.disabled = false; });
})();
</script>
{# Asegúrate de cargar Alpine v3 en base.html:
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script> #}
{% endblock %}
