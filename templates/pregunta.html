{% extends "base.html" %}

{% block content %}
<div class="card fade-in">
    <h1>❓ Pregunta del día</h1>

    {% if ruta_audio %}
        <div class="audio-container">
            <button id="play-audio" class="btn secondary-btn">
                ▶ Escuchar audio
            </button>
            <audio id="player" preload="auto" style="display:none;">
                <source src="{{ url_for('static', filename=ruta_audio) }}" type="audio/mpeg">
                Tu navegador no soporta el elemento de audio.
            </audio>
        </div>

        <script>
        (function () {
            const player = document.getElementById('player');
            const btn = document.getElementById('play-audio');
            const LIMIT = 5; // segundos

            btn.addEventListener('click', () => {
                player.currentTime = 0;
                player.play();
                btn.disabled = true; // opcional: evitar spam de clics
            });

            // Detener a los 5 segundos
            player.addEventListener('timeupdate', () => {
                if (player.currentTime >= LIMIT) {
                    player.pause();
                    player.currentTime = 0;
                    btn.disabled = false;
                }
            });
        })();
        </script>
    {% endif %}
    {% if ruta_imagen %}
        <div class="image-container">
            <img src="{{ url_for('static', filename=ruta_imagen) }}" alt="Imagen de la pregunta" style="max-width:100%;border-radius:8px;margin-top:1rem;">
        </div>
    {% endif %}


    <h2 class="question-title">{{ pregunta["pregunta"] }}</h2>

    <form method="POST" action="{{ url_for('preguntas.ver_pregunta') }}">
        <div class="answers-container">
            {% for r in respuestas %}
            <label class="radio-option">
                <input type="radio" name="respuesta" value="{{ r['id'] }}">
                {{ r['respuesta'] }}
            </label>
            {% endfor %}
        </div>

        <div class="timer-container">
            <div class="timer-circle" id="timer-circle">
                <span class="timer-number" id="timer-number">30</span>
            </div>
         </div>
         <button type="submit" class="btn primary-btn" style="margin-top: 1.5rem;">
            <i class="fa-solid fa-paper-plane"></i> Responder
        </button>

    </form>
</div>

<script>
  const TOTAL = 30;
  let segundos = TOTAL;

  const circle = document.getElementById("timer-circle");
  const number = document.getElementById("timer-number");
  const TIMEOUT_URL = "{{ url_for('preguntas.timeout', pregunta_id=pregunta.id) }}";

  function pintar() {
    // Calcular ángulo horario: va de 360 a 0
    const angle = 360 * (segundos / TOTAL);
    circle.style.setProperty('--angle', `${angle}deg`);
    number.textContent = segundos;

    if (segundos <= 5) {
      circle.classList.add('timer-danger');
      circle.classList.remove('timer-warn');
    } else if (segundos <= 10) {
      circle.classList.add('timer-warn');
      circle.classList.remove('timer-danger');
    } else {
      circle.classList.remove('timer-warn', 'timer-danger');
    }
  }

  pintar();
  const intervalo = setInterval(() => {
    segundos--;
    pintar();
    if (segundos <= 0) {
      clearInterval(intervalo);
      window.location.replace(TIMEOUT_URL);
    }
  }, 1000);
</script>


{% endblock %}
