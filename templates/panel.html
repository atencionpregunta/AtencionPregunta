{% extends "base.html" %}
{% set body_class = 'app-shell tone-soft page-admin' %}
{% block title %}Panel de AdministraciÃ³n Â· SQL Â· Reto Diario{% endblock %}

{% block extra_head %}
<style>
  :root{ --input-h:46px; --input-px:14px; --input-radius:14px; }

  .admin-shell{ max-width:1000px; margin:0 auto; }
  .lead{ color:var(--muted); margin:6px 0 10px; }

  /* Campos */
  .form-row{ display:grid; gap:8px; margin-top:10px; }
  .form-row label{ font-weight:700; font-size:.95rem; }

  .input, .textarea{
    width:100%;
    box-sizing:border-box;
    border:1px solid var(--line);
    border-radius:var(--input-radius);
    background:#fff;
    font:inherit;
    outline:none;
    box-shadow:0 3px 10px rgba(0,0,0,.05);
  }
  .input{ height:var(--input-h); padding:0 var(--input-px); }
  .textarea{
    padding:10px var(--input-px);
    min-height:220px; resize:vertical;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    line-height:1.35;
    tab-size: 2;
  }
  .input:focus, .textarea:focus{
    border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(239,68,68,.15);
  }

  /* Controles */
  .controls{
    display:grid; gap:10px; margin-top:12px;
    grid-template-columns: 1fr auto;
    align-items:center;
  }
  .controls .row{
    display:flex; gap:12px; align-items:center; flex-wrap:wrap;
  }
  .checkbox{
    display:inline-flex; align-items:center; gap:6px;
    font-size:.95rem;
  }
  .checkbox input{ transform: scale(1.05); }

  /* Tabla resultados */
  .table-wrap{ overflow:auto; margin-top:12px; }
  table.adm { width:100%; border-collapse:collapse; }
  table.adm th, table.adm td{ text-align:left; padding:8px 10px; }
  table.adm thead th{
    border-bottom:1px solid var(--line);
    font-weight:800; font-size:.92rem; white-space:nowrap;
    background:#fafafa;
  }
  table.adm tbody td{ border-bottom:1px solid #f1f1f1; font-size:.92rem; }
  table.adm tbody tr:hover{ background:#fafafa; }

  /* Alertas */
  .alert{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    margin-top:12px;
  }
  .alert.error{ background:#ffe5e5; border-color:#f5a3a3; }
  .alert.ok{ background:#e8fff0; border-color:#9be2b0; }

  /* Botones coherentes con el sistema */
  .actions .btn{ border-radius:12px; }
  .btn.danger-outline{ color:#b91c1c; border-color:#fecaca; }
  .btn.danger-outline:hover{ background:#fef2f2; }

  @media (max-width:720px){
    .controls{ grid-template-columns: 1fr; }
    .actions .btn{ width:100%; }
  }
</style>
{% endblock %}

{% block content %}
<div class="admin-shell">
  <h1>ðŸ‘‘ Panel de AdministraciÃ³n â€” SQL</h1>
  <p class="lead">
    Modo lectura por defecto: permite <code>SELECT</code>, <code>WITH</code>, <code>EXPLAIN</code> en una sola sentencia.
    Activa <strong>Permitir escritura</strong> para ejecutar <code>INSERT/UPDATE/DELETE/...</code>.
  </p>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="post" action="{{ url_for('admin.panel_admin') }}">
    <div class="form-row">
      <label for="sql">SQL</label>
      <textarea id="sql" name="sql" class="textarea" spellcheck="false">{{ sql }}</textarea>
    </div>

    <div class="controls">
      <div class="row">
        <label class="checkbox">
          Filas mÃ¡x. a mostrar:
          <input class="input" type="number" min="1" max="5000" name="limit" value="{{ limit }}" style="width:110px;">
        </label>
        <label class="checkbox">
          <input type="checkbox" name="allow_write" {% if allow_write %}checked{% endif %}>
          Permitir escritura (Â¡peligroso!)
        </label>
      </div>

      <div class="row actions">
        <button type="submit" class="btn primary-btn">
          <i class="fa-solid fa-play"></i> Ejecutar
        </button>
        <a class="btn secondary-btn" href="{{ url_for('admin.panel_admin') }}">
          <i class="fa-solid fa-rotate-left"></i> Reset
        </a>
        <a class="btn secondary-btn danger-outline" href="{{ url_for('admin.logout_admin') }}">
          <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesiÃ³n
        </a>
      </div>
    </div>
  </form>

  {% if error %}
    <div class="alert error">
      <strong>Error:</strong> {{ error }}
    </div>
  {% endif %}

  {% if message %}
    <div class="alert ok">
      {{ message }}{% if elapsed_ms is not none %} â€” {{ elapsed_ms }} ms{% endif %}
    </div>
  {% endif %}

  {% if rows and columns %}
    <div class="table-wrap">
      <table class="adm">
        <thead>
          <tr>
            {% for c in columns %}
              <th>{{ c }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              {% for c in columns %}
                <td>
                  {{ r[c] if r is mapping else r[loop.index0] }}
                </td>
              {% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <p style="opacity:.7;margin-top:6px;">Mostrando hasta {{ limit }} filas.</p>
    </div>
  {% elif elapsed_ms is not none and not error %}
    <p style="margin-top:12px;opacity:.7;">La consulta no devolviÃ³ filas.</p>
  {% endif %}
</div>
{% endblock %}
