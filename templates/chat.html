{% extends "base.html" %}
{% set body_class = 'page-chat' %}
{% block title %}Chat del grupo Â· Reto Diario{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto" role="application" aria-label="Chat del grupo">
  <!-- Header -->
  <header class="flex items-center justify-between gap-2 mb-3">
    <a href="{{ url_for('resultados.ver_resultados', id_grupo=id_grupo) }}"
       class="inline-grid place-items-center w-10 h-10 rounded-full border border-rose-100 bg-white hover:bg-neutral-50"
       aria-label="Volver a resultados">
      <i class="fa-solid fa-arrow-left"></i>
    </a>
    <h1 class="text-lg sm:text-xl font-extrabold text-brand">ðŸ’¬ Chat del grupo</h1>
    <span class="w-10 h-10"></span>
  </header>

  <!-- Shell fijo -->
  <div class="bg-white border border-rose-100 rounded-2xl shadow-xl p-2 sm:p-3 grid
              grid-rows-[1fr_auto]
              h-[65vh] sm:h-[70vh] lg:h-[80vh]">

    <!-- Log con scroll interno -->
    <div id="chat-box"
         class="bg-neutral-50/60 border border-rose-100 rounded-xl p-2 sm:p-3 overflow-y-auto space-y-2 h-full"
         role="log" aria-live="polite" aria-relevant="additions text">
      {% set badges = badges|default({}) %}
      {% if mensajes and mensajes|length %}
        {% for m in mensajes %}
          {% set b = badges.get(m['id_usuario'], {}) %}
          {% set ac = b.get('acierto') %}
          {% set rk = b.get('rank') %}
          {% set nombre = (m['usuario_nombre'] or ('Usuario ' ~ m['id_usuario'])) %}
          {% set own = (session.get('usuario_id') == m['id_usuario']) %}

          <div class="msg flex items-end gap-2 {{ 'justify-end' if own else '' }}" data-id="{{ m['id'] }}">
            <!-- Avatar -->
            <div class="avatar shrink-0 w-8 h-8 rounded-full ring-2 ring-offset-2 overflow-hidden
                        {{ 'ring-emerald-400' if ac is true else ('ring-red-400' if ac is false else 'ring-neutral-300') }}">
              {% if m['foto_url'] %}
                <img src="{{ m['foto_url'] }}" alt="avatar" class="w-full h-full object-cover" loading="lazy">
              {% else %}
                <div class="w-full h-full grid place-items-center bg-rose-50 text-rose-700 font-bold text-xs">
                  {{ (nombre|trim|upper)[:2] }}
                </div>
              {% endif %}
            </div>

            <!-- Burbuja -->
            <div class="bubble max-w-[88%] md:max-w-[72%] lg:max-w-[62%]
                        rounded-xl border px-3 py-2 shadow-sm
                        {{ 'bg-emerald-50 border-emerald-200' if own else 'bg-white border-neutral-200' }}">
              <div class="meta flex items-center gap-2 mb-0.5">
                <span class="name text-[.78rem] font-semibold text-neutral-800 opacity-80">{{ nombre }}</span>
                {% if rk %}
                  <span class="rankchip text-[.68rem] font-extrabold px-2 py-0.5 rounded-full border border-neutral-200 bg-neutral-50 text-neutral-700">#{{ rk }}</span>
                {% endif %}
              </div>
              <p class="text m-0 text-sm text-neutral-900 whitespace-pre-line break-words">{{ m['contenido'] }}</p>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p id="empty-hint" class="text-center text-neutral-600 py-6">AÃºn no hay mensajes. Â¡Escribe el primero!</p>
      {% endif %}
    </div>

    <!-- Composer fijo -->
    <form action="{{ url_for('chat.enviar_mensaje', id_grupo=id_grupo) }}"
          method="POST" class="grid grid-cols-[1fr_auto] gap-2 items-center pt-2" novalidate>
      <label class="sr-only" for="contenido">Escribe un mensaje</label>
      <textarea id="contenido" name="contenido"
                class="input chat-input w-full h-12 sm:h-14 resize-none overflow-y-auto rounded-xl border border-neutral-200 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-4 focus:ring-rose-300"
                placeholder="Escribe un mensajeâ€¦" required autocomplete="off" maxlength="500"></textarea>
      <button class="btn primary-btn send inline-flex items-center justify-center h-12 sm:h-14 px-4 rounded-xl text-white
                     bg-gradient-to-tr from-brand to-brand-dark shadow-sm hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
              type="submit" aria-label="Enviar mensaje" disabled>
        <i class="fa-solid fa-paper-plane"></i>
        <span class="ml-2 hidden sm:inline">Enviar</span>
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const box   = document.getElementById('chat-box');
  const form  = document.querySelector('form[method="POST"].grid');
  const input = form.querySelector('#contenido');
  const send  = form.querySelector('.send');
  const userId = {{ session.get('usuario_id', 0) }};

  // Ãºltima id pintada
  let lastId = (() => {
    const last = box.querySelector('.msg:last-of-type');
    return last ? Number(last.dataset.id) || 0 : 0;
  })();

  // helpers
  const escapeHtml = (s) => { const d = document.createElement('div'); d.innerText = s ?? ''; return d.innerHTML; };
  const atBottom   = () => (box.scrollHeight - box.scrollTop - box.clientHeight) < 80;
  const scrollBottom = () => { box.scrollTop = box.scrollHeight; };

  const avatarHtml = (foto_url, nombre, acierto) => {
    const ring = (acierto === true) ? "ring-emerald-400" : (acierto === false) ? "ring-red-400" : "ring-neutral-300";
    if (foto_url){
      return `<div class="avatar shrink-0 w-8 h-8 rounded-full ring-2 ring-offset-2 overflow-hidden ${ring}">
                <img src="${foto_url}" alt="avatar" class="w-full h-full object-cover" loading="lazy">
              </div>`;
    } else {
      const initials = (nombre || "U").trim().toUpperCase().slice(0,2);
      return `<div class="avatar shrink-0 w-8 h-8 rounded-full ring-2 ring-offset-2 overflow-hidden ${ring}">
                <div class="w-full h-full grid place-items-center bg-rose-50 text-rose-700 font-bold text-xs">${initials}</div>
              </div>`;
    }
  };

  function appendMessage(m){
    const own = userId === m.id_usuario;
    const safeNombre = escapeHtml(m.usuario_nombre || ('Usuario ' + m.id_usuario));
    const side = own ? 'justify-end' : '';
    const bubbleCls = own ? 'bg-emerald-50 border-emerald-200' : 'bg-white border-neutral-200';

    const el = document.createElement('div');
    el.className = `msg flex items-end gap-2 ${side}`;
    el.dataset.id = m.id;

    el.innerHTML = `
      ${avatarHtml(m.foto_url, m.usuario_nombre, m.acierto)}
      <div class="bubble max-w-[88%] md:max-w-[72%] lg:max-w-[62%] rounded-xl border px-3 py-2 shadow-sm ${bubbleCls}">
        <div class="meta flex items-center gap-2 mb-0.5">
          <span class="name text-[.78rem] font-semibold text-neutral-800 opacity-80">${safeNombre}</span>
          ${m.rank ? `<span class="rankchip text-[.68rem] font-extrabold px-2 py-0.5 rounded-full border border-neutral-200 bg-neutral-50 text-neutral-700">#${m.rank}</span>` : ''}
        </div>
        <p class="text m-0 text-sm text-neutral-900 whitespace-pre-line break-words"></p>
      </div>
    `;
    el.querySelector('.text').textContent = m.contenido || '';

    document.getElementById('empty-hint')?.remove();
    box.appendChild(el);
    compactThreads();
  }

  // autoscroll inicial
  scrollBottom();

  // polling
  async function poll(){
    try{
      const keep = atBottom();
      const url = `{{ url_for('chat.api_mensajes', id_grupo=id_grupo) }}?after_id=${encodeURIComponent(lastId)}`;
      const r = await fetch(url, { headers:{ 'Accept':'application/json' }, cache:'no-store' });
      if(!r.ok) return;
      const { mensajes = [] } = await r.json() || {};
      if (!mensajes.length) return;

      for (const m of mensajes){
        appendMessage(m);
        if (typeof m.id !== 'undefined') {
          const idNum = Number(m.id) || 0;
          if (idNum > lastId) lastId = idNum;
        }
      }
      if (keep) scrollBottom();
    }catch(_e){ /* silencioso */ }
  }
  setInterval(poll, 3000);

  // Activar/desactivar botÃ³n enviar
  input.addEventListener('input', () => {
    send.disabled = input.value.trim().length === 0;
  });
  send.disabled = true;

  // Enter = enviar; Shift+Enter = salto
  input.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter' && !ev.shiftKey){
      ev.preventDefault();
      if (!send.disabled) send.click();
    }
  });

  // Evita dobles envÃ­os y baja scroll
  form.addEventListener('submit', () => {
    send.disabled = true;
    setTimeout(scrollBottom, 120);
  });

  // Agrupar consecutivos
  function compactThreads(){
    const nodes = [...box.querySelectorAll('.msg')];
    for (let i = 1; i < nodes.length; i++){
      const prev = nodes[i-1], cur = nodes[i];
      const prevMine = prev.classList.contains('justify-end');
      const curMine  = cur.classList.contains('justify-end');
      if (prevMine === curMine) {
        cur.classList.add('cont');
        const av = cur.querySelector('.avatar');
        const meta = cur.querySelector('.meta');
        if (av){ av.style.visibility='hidden'; av.style.width='0'; av.style.height='0'; av.style.margin='0'; }
        if (meta){ meta.style.display='none'; }
      }
    }
  }
  compactThreads();
})();
</script>
{% endblock %}
