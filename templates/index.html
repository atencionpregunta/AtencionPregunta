{% extends "base.html" %}
{% set body_class = 'app-shell tone-soft page-index' %}
{% block title %}Inicio ¬∑ Reto Diario{% endblock %}

{% block extra_head %}
<style>
  /* ===== Center/T√≠tulo + mascota ===== */
  .page-index .ATPPet-title{
    display:block; width:120px; margin:12px auto 6px;
  }
  .page-index h1{
    display:block; width:100%;
    text-align:center !important;
    margin:8px 0 8px !important;
  }
  .page-index .welcome,
  .page-index .info{ margin:6px 0 8px !important; text-align:center; }

  /* ===== Grupo de acciones: menos separaci√≥n y botones gorditos ===== */
  .page-index .actions{
    display:grid; grid-template-columns:1fr;
    gap:6px;                 /* <-- menos hueco */
    margin-top:8px;
  }
  .page-index .actions .btn{
    width:100%;
    min-height:46px;         /* gorditos */
    padding:12px 16px;
    border-radius:12px;
    font-weight:800;
    font-size:.95rem;
    line-height:1.1;
  }
  .page-index .actions .primary-btn{
    background:linear-gradient(135deg,#2563eb,#1d4ed8);
    color:#fff; border:0;
    box-shadow:0 6px 18px rgba(29,78,216,.20);
  }
  .page-index .actions .secondary-btn{
    background:#fff;
    border:1.5px solid #e5e7eb;
    color:#111827;
  }
  /* Bot√≥n peque (no a 100% de ancho) */
  .page-index .small-btn{
    width:auto; min-height:36px; padding:8px 12px; border-radius:10px; font-weight:700;
  }

  /* ===== Flotantes: ayuda (?) izda y salir dcha ===== */
  .help{
    position:fixed;
    left:max(12px, env(safe-area-inset-left));
    top:max(12px, env(safe-area-inset-top));
    z-index:1100;
  }
  .help-btn{
    display:inline-grid; place-items:center;
    width:36px; height:36px; border-radius:999px;
    border:1px solid var(--line); background:#fff; color:#111827; font-weight:800;
    box-shadow:0 6px 20px rgba(2,6,23,.08); cursor:pointer;
  }
  .help-card{
    position:absolute; left:0; top:44px; width:min(92vw,340px);
    background:var(--card); border:1px solid var(--line); border-radius:14px;
    box-shadow:0 16px 40px rgba(2,6,23,.15); padding:10px 12px 12px; display:none;
  }
  .help-card.is-open{ display:block; }
  .help-header{ font-size:.95rem; margin-bottom:6px; }
  .help-content{ font-size:.9rem; }
  .help-content ul{ margin:.25rem 0 .5rem 1.1rem; padding:0; }
  .help-note{ margin:.5rem 0 0; color:var(--muted); font-size:.85rem; }
  .help-footer{ margin-top:8px; display:flex; justify-content:flex-end; }
  .help-close{ border:1px solid var(--line); background:#fff; color:#111827; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:700; }

  .logout-float{
    position:fixed;
    top:max(12px, env(safe-area-inset-top));
    right:max(12px, env(safe-area-inset-right));
    z-index:1100;
  }
  .logout-float.btn{     /* evita width:100% heredado */
    width:auto; min-height:36px; padding:8px 12px; border-radius:10px; font-weight:700;
    box-shadow:0 6px 18px rgba(2,6,23,.08);
  }

  /* Compacta m√°rgenes dentro de la card de esta p√°gina */
  .page-index .card p{ margin:6px 0 !important; }

  /* Compacta textos encima */
  .page-index .welcome,
  .page-index .info{ margin:6px 0 !important; text-align:center; }

  /* Misma columna + sin m√°rgenes verticales entre botones */
  .page-index .actions{
    display:flex; flex-direction:column;
    gap:4px !important;             /* <‚Äî controla la separaci√≥n */
    margin-top:8px !important;
  }
  .page-index .actions .btn{
    margin:0 !important;             /* mata el margin global */
    min-height:46px;                 /* m√°s ‚Äúgorditos‚Äù */
    padding:12px 16px;
    border-radius:12px; font-weight:800; font-size:.95rem;
  }
  /* Fallback por si alguna .btn externa hereda margen */
  .page-index .btn + .btn{ margin-top:4px !important; }

</style>
{% endblock %}

{% block content %}
  <img class="ATPPet-title" src="{{ url_for('static', filename='img/ATPPet-180.png') }}" alt="ATPPet del reto" loading="lazy" decoding="async">
  <h1>üö® Atenci√≥n Pregunta üö®</h1>

  {% if session.get("usuario_id") %}
    <p class="welcome">Bienvenido, <strong>{{ session["usuario_nombre"] }}</strong> üëã</p>

    {% if grupo_actual %}
      {% if ya_respondido %}
        <p class="info">‚úÖ Ya has respondido a la pregunta de hoy.</p>
        <div class="actions">
          <a href="{{ url_for('resultados.ver_resultados', id_grupo=id_grupo) }}" class="btn primary-btn">
            <i class="fa-solid fa-chart-simple"></i> Ver resultados
          </a>
          <a href="{{ url_for('grupos.gestionar_grupos') }}" class="btn secondary-btn small-btn">
            <i class="fa-solid fa-gear"></i> Grupos
          </a>
        </div>
      {% else %}
        <div class="actions">
          <form method="GET" action="{{ url_for('preguntas.ver_pregunta') }}">
            <button class="btn primary-btn" type="submit">
              <i class="fa-solid fa-bolt"></i> Vamos a por esa preguntilla
            </button>
          </form>
          <a href="{{ url_for('grupos.gestionar_grupos') }}" class="btn secondary-btn small-btn">
            <i class="fa-solid fa-gear"></i> Grupos
          </a>
        </div>
      {% endif %}
    {% else %}
      <p class="info">‚ö†Ô∏è Debes <strong>unirte</strong> o <strong>crear</strong> un grupo para participar.</p>
      <div class="actions">
        <a href="{{ url_for('auth.login_form') }}" class="btn primary-btn">
          <i class="fa-solid fa-user-lock"></i> Iniciar sesi√≥n
        </a>
        <a href="{{ url_for('google.login') }}" class="btn google-btn">
          <i class="fa-brands fa-google"></i> Iniciar con Google
        </a>
        <a href="{{ url_for('auth.crear_usuario') }}" class="btn secondary-btn">
          <i class="fa-solid fa-user-plus"></i> Crear cuenta
        </a>
      </div>
    {% endif %}
  {% else %}
    <p class="info">Inicia sesi√≥n para continuar</p>
    <div class="actions">
      <a href="{{ url_for('auth.login_form') }}" class="btn primary-btn">
        <i class="fa-solid fa-user-lock"></i> Iniciar sesi√≥n
      </a>
      <a href="{{ url_for('google.login') }}" class="btn google-btn">
        <i class="fa-brands fa-google"></i> Iniciar con Google
      </a>
      <a href="{{ url_for('auth.crear_usuario') }}" class="btn secondary-btn">
        <i class="fa-solid fa-user-plus"></i> Crear cuenta
      </a>
    </div>
  {% endif %}
{% endblock %}

{% block floating %}
  <!-- Ayuda (?) izquierda -->
  <div class="help" id="helpRoot">
    <button class="help-btn" id="helpBtn" aria-haspopup="dialog" aria-controls="helpCard" aria-expanded="false" title="Ayuda"><span>?</span></button>
    <div class="help-card" id="helpCard" role="dialog" aria-label="Ayuda: ¬øC√≥mo funciona?">
      <header class="help-header"><strong>¬øC√≥mo funciona?</strong></header>
      <div class="help-content">
        <ul>
          <li><b>Pregunta diaria:</b> se publica cada d√≠a (hora Madrid).</li>
          <li><b>Responde</b> una vez; cambiar no punt√∫a.</li>
          <li><b>Puntuaci√≥n:</b> correcta suma y te posiciona en la clasificaci√≥n.</li>
          <li><b>Grupos:</b> entra a tu grupo para ver el ranking.</li>
          <li><b>Chat:</b> comenta con tu grupo desde el bot√≥n de chat.</li>
        </ul>
        <p class="help-note">Consejo: usa el selector de grupo (m√≥vil) o la sidebar (PC).</p>
      </div>
    </div>
  </div>

  {% if session.get("usuario_id") %}
    <!-- Salir derecha -->
    <a href="{{ url_for('auth.logout') }}" class="btn secondary-btn small-btn logout-float">
      <i class="fa-solid fa-right-from-bracket"></i> Salir
    </a>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
  (function(){
    const root = document.getElementById('helpRoot');
    const btn  = document.getElementById('helpBtn');
    const card = document.getElementById('helpCard');
    const closeB = document.getElementById('helpClose');

    function openHelp(){ card.classList.add('is-open'); btn.setAttribute('aria-expanded','true'); }
    function closeHelp(){ card.classList.remove('is-open'); btn.setAttribute('aria-expanded','false'); }
    function toggleHelp(){ card.classList.contains('is-open') ? closeHelp() : openHelp(); }

    btn.addEventListener('click', toggleHelp);
    closeB.addEventListener('click', closeHelp);
    document.addEventListener('click', (e)=>{ if(!root.contains(e.target)) closeHelp(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeHelp(); });
  })();
</script>
{% endblock %}
