<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Resultados</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f4f6f9; --card:#fff; --text:#333; --muted:#777;
      --line:#e5e7eb; --accent:#1976d2; --ok:#28a745; --bad:#dc3545;
      --ok-bg:#d4edda; --bad-bg:#f8d7da;
    }
    body{
      margin:0; min-height:100vh; display:flex; justify-content:center; align-items:flex-start;
      padding:48px 16px; background:var(--bg); font-family:system-ui, Segoe UI, Inter, sans-serif; color:var(--text);
    }
    .card{
      width:100%; max-width:780px; background:var(--card); border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.08); padding:24px; animation:fadeIn .5s ease;
    }
    h2{ margin:0 0 4px; font-size:1.6rem }
    .sub{ color:var(--muted); margin:0 0 16px; font-size:.95rem }

    /* toolbar */
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 8px 0 16px; }
    .toolbar .select{
      padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#fff; font-size:.95rem;
    }
    .btn-link{
      text-decoration:none; padding:8px 12px; border:1px solid var(--line); border-radius:8px; color:#333;
      background:#fff;
    }

    table{ width:100%; border-collapse:collapse; }
    thead th{
      text-align:left; font-weight:600; font-size:.9rem; color:#555; padding:12px 10px; border-bottom:1px solid var(--line);
    }
    tbody td{ padding:12px 10px; border-bottom:1px solid var(--line); vertical-align:middle; }
    tbody tr{ opacity:0; animation:rowIn .5s ease forwards; }
    tbody tr:nth-child(1){ animation-delay:.05s } tbody tr:nth-child(2){ animation-delay:.1s }
    tbody tr:nth-child(3){ animation-delay:.15s } tbody tr:nth-child(4){ animation-delay:.2s }
    tbody tr:nth-child(5){ animation-delay:.25s } tbody tr:nth-child(6){ animation-delay:.3s }

    .pos{ width:64px; font-weight:700 }
    .user{ display:flex; align-items:center; gap:.6rem; }
    .medal{ font-size:1.1rem }
    .you{ padding:.18rem .5rem; border-radius:999px; background:#eef6ff; color:#0b57d0; font-size:.75rem; font-weight:700 }

    .scorebar{
      position:relative; width:100%; height:22px; background:#eee; border-radius:10px; overflow:hidden;
    }
    .fill{
      height:100%; background:linear-gradient(90deg, #4caf50, #66bb6a);
      color:#fff; font-weight:700; font-size:.85rem; line-height:22px; text-align:center;
      transition:width .6s ease;
    }
    .muted{ color:var(--muted); font-size:.9rem }

    /* Resaltado de tu fila según acierto */
    .me-ok{ background:var(--ok-bg) !important; outline:2px solid var(--ok); }
    .me-bad{ background:var(--bad-bg) !important; outline:2px solid var(--bad); }

    @keyframes fadeIn{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none} }
    @keyframes rowIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

    /* Responsive */
    @media (max-width:640px){
      .pos{ width:44px }
      .fill{ font-size:.8rem }
      thead .estado-col{ display:none } tbody .estado-col{ display:none }
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>📊 Clasificación</h2>

    {# localizar el grupo seleccionado para mostrar su código bonito #}
    {% set grupo_sel = (grupos_usuario | selectattr('id','equalto', id_grupo) | list | first) %}
    <p class="sub">
      Clasificación general del grupo seleccioando
      {% if grupo_sel %} · <strong>Grupo:</strong> {{ grupo_sel.codigo }}{% endif %}
    </p>

    <!-- Toolbar: selector de grupo + volver -->
    <div class="toolbar">
      <form method="GET" action="{{ url_for('resultados.ver_resultados') }}">
        <label for="id_grupo"><strong>Grupo:</strong></label>
        <select name="id_grupo" id="id_grupo" class="select" onchange="this.form.submit()">
          {% for g in grupos_usuario %}
            <option value="{{ g.id }}" {% if g.id == id_grupo %}selected{% endif %}>
              {{ g.codigo }}
            </option>
          {% endfor %}
        </select>
        <noscript><button type="submit" class="btn-link">Ver</button></noscript>
      </form>

      <a class="btn-link" href="{{ url_for('index') }}">⬅️ Volver al inicio</a>
    </div>

    {% set max_p = (resultados | map(attribute='puntuacion') | max) if resultados else 1 %}

    <table>
      <thead>
        <tr>
          <th class="pos">Pos</th>
          <th>Nombre</th>
          <th>Puntuación</th>
          <!-- <th class="estado-col">Estado</th> -->
        </tr>
      </thead>
      <tbody>
        {% for r in resultados %}
          {% set pos = loop.index %}
          {% set medal = '🥇' if pos==1 else ('🥈' if pos==2 else ('🥉' if pos==3 else '')) %}
          {% set is_you = (r.id_usuario == session['usuario_id']) %}
          {% set row_class = 'me-ok' if is_you and r.correcta==1 else ('me-bad' if is_you and r.correcta==0 else '') %}
          <tr class="{{ row_class }}">
            <td class="pos">{{ pos }}</td>
            <td class="user">
              {% if medal %}<span class="medal">{{ medal }}</span>{% endif %}
              <span>{{ r.usuario }}</span>
              {% if is_you %}<span class="you">TÚ</span>{% endif %}
            </td>
            <td>
              <div class="scorebar" title="Puntuación: {{ r.puntuacion }}">
                  {% set pct = (r.puntuacion / (max_p if max_p else 1) * 100) | round(0) %}
                  {% if r.puntuacion == 0 %}
                  <div class="fill" style="width: 0%"></div>
                  <span style="position:absolute; left:50%; transform:translateX(-50%); font-weight:700; font-size:.85rem; color:#333">
                      0
                  </span>
                  {% elif pct >= 15 %}
                  <div class="fill" style="width: {{ pct }}%">{{ r.puntuacion }}</div>
                  {% else %}
                  <div class="fill" style="width: {{ pct }}%"></div>
                  <span style="position:absolute; left:50%; transform:translateX(-50%); font-weight:700; font-size:.85rem; color:#333">
                      {{ r.puntuacion }}
                  </span>
                  {% endif %}
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if not resultados %}
      <p class="muted" style="margin-top:16px">Aún no hay resultados para este grupo.</p>
    {% endif %}
  </div>
</body>
</html>
