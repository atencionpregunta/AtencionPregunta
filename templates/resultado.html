<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Resultados · Reto Diario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/ATPPet-32.png') }}">
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='img/ATPPet-16.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/ATPPet-180.png') }}">

  <style>

    
    :root{
      --bg: #f7f8fb; --card: #fff; --text:#171717; --muted:#6b7280; --line:#e8eaf0;
      --chip:#eef2ff; --chip-ink:#3730a3; --ok:#16a34a; --bad:#dc2626;
      /* Paleta HSL base (neutra) */
      --ok-hsl: 142 55% 46%;
      --bad-hsl: 0 70% 50%;
      --unk-hsl: 215 12% 60%;
    }
    /* Modo suave/pastel (flojo) */
    .tone-soft{
      --ok-hsl: 142 45% 68%;
      --bad-hsl: 0  55% 72%;
      --unk-hsl: 215 10% 72%;
    }
    /* Modo saturado (vivo) */
    .tone-strong{
      --ok-hsl: 142 75% 42%;
      --bad-hsl: 0  78% 46%;
      --unk-hsl: 215 16% 56%;
    }

    body{
      margin:0; min-height:100vh; display:flex; justify-content:center; align-items:flex-start;
      padding:48px 16px; font-family: Inter, system-ui, Segoe UI, Arial, sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 600px at 0% -10%, #eef2ff 0%, transparent 60%),
        radial-gradient(1000px 500px at 100% 0%, #e0f2fe 0%, transparent 55%),
        var(--bg);
    }
    .card{
      width:100%; max-width:1000px; background:var(--card);
      border:1px solid var(--line); border-radius:18px; box-shadow: 0 12px 40px rgba(2, 6, 23, .06);
      padding:20px; animation:fadeIn .5s ease;
    }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none} }

    /* Layout con sidebar */
    .layout{ display:grid; grid-template-columns: 220px 1fr; gap:16px; }
    .side{
      border:1px solid var(--line); border-radius:14px; padding:12px;
      position: sticky; top:20px; align-self:start; background:#fff;
    }
    .side h3{ margin:0 0 8px; font-size:1rem }
    .glist{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px; }
    .gitem a{
      display:flex; align-items:center; gap:.5rem; padding:8px 10px; border-radius:10px;
      color:#111827; text-decoration:none; border:1px solid transparent;
    }
    .gitem a:hover{ background:#f8fafc; border-color:#eef2f7; }
    .gitem .dot{ width:8px; height:8px; border-radius:999px; background:#cbd5e1; }
    .gitem.active a{ background:#eef6ff; border-color:#dbeafe; }
    .gitem.active .dot{ background:#0b57d0; }
    .side .mini-actions{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .side .mini-actions a{
      border:1px solid var(--line); border-radius:10px; padding:6px 8px; font-size:.85rem; text-decoration:none; color:#111827;
      background:#fff;
    }

    /* Contenido principal */
    .main{ padding:6px 4px; }
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .title{ display:flex; align-items:center; gap:.6rem; }
    .title h2{ margin:0; font-size:1.55rem }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .6rem; border-radius:999px;
      background:var(--chip); color:var(--chip-ink); font-weight:700; font-size:.8rem; border:1px solid #e5e7eb;
    }
    .meta{ color:var(--muted); margin:8px 0 16px; font-size:.95rem }

    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin: 6px 0 16px; }
    .btn-link{
      text-decoration:none; padding:9px 12px; border:1px solid var(--line); border-radius:10px; color:#111827; background:#fff; font-weight:700;
    }
    .btn-link:hover{ border-color:#d6dae3; box-shadow:0 2px 10px rgba(2,6,23,.06) }

    /* Toggle de tono */
    .tone-toggle{
      display:flex; align-items:center; gap:8px; border:1px solid var(--line); border-radius:999px; padding:6px;
      background:#fff;
    }
    .tone-toggle button{
      border:none; background:transparent; padding:6px 10px; border-radius:999px; cursor:pointer; font-weight:700;
      color:#334155;
    }
    .tone-toggle button.active{ background:#eef2ff; color:#1d4ed8; }

    /* Tabla */
    table{ width:100%; border-collapse:collapse; }
    thead th{ text-align:left; font-weight:800; font-size:.8rem; color:#475569; padding:10px; border-bottom:1px solid var(--line); letter-spacing:.3px; text-transform:uppercase; }
    tbody td{ padding:12px 10px; border-bottom:1px solid var(--line); vertical-align:middle; }
    tbody tr{ opacity:0; animation:rowIn .45s ease forwards; }
    @keyframes rowIn{ from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none} }

    .pos{ width:64px; font-weight:800 }
    .user{ display:flex; align-items:center; gap:.65rem; }

    .avatar-wrap{ position: relative; display:inline-grid; width:34px; height:34px; margin-right:.1rem; }
    .avatar{
      width:34px; height:34px; border-radius:999px; display:grid; place-items:center; font-weight:800;
      background:#eef2ff; color:#3730a3; border:1px solid #e5e7eb; text-transform:uppercase; font-size:.85rem;
      box-shadow:inset 0 1px 0 #fff, 0 2px 8px rgba(2,6,23,.05);
    }

    /* Aro de estado (usa HSL con alpha, ajustado por .tone-soft / .tone-strong) */
    .avatar.ok  { box-shadow: inset 0 0 0 2px hsl(var(--ok-hsl) / .40), 0 0 0 4px hsl(var(--ok-hsl) / .18); }
    .avatar.bad { box-shadow: inset 0 0 0 2px hsl(var(--bad-hsl)/ .40), 0 0 0 4px hsl(var(--bad-hsl)/ .18); }
    .avatar.unk { box-shadow: inset 0 0 0 2px hsl(var(--unk-hsl)/ .45); }

    /* Mini-badge de estado */
    .badge{
      position:absolute; right:-3px; bottom:-3px;
      width:16px; height:16px; border-radius:999px;
      display:grid; place-items:center; font-size:.65rem; line-height:1;
      background:#fff; border:1px solid #e5e7eb; color:#fff;
    }
    .badge.ok  { background: hsl(var(--ok-hsl) / .90);  border-color: hsl(var(--ok-hsl));  }
    .badge.bad { background: hsl(var(--bad-hsl)/ .90);  border-color: hsl(var(--bad-hsl)); }
    .badge.unk { background: hsl(var(--unk-hsl)/ .90);  border-color: hsl(var(--unk-hsl)); }

    .you{ padding:.22rem .55rem; border-radius:999px; background:#eef6ff; color:#0b57d0; font-size:.75rem; font-weight:800 }

    .scorebar{ position:relative; width:100%; height:24px; background:#f3f4f6; border-radius:12px; overflow:hidden; border:1px solid #eceff3; }
    .fill{ height:100%; color:#064e3b; font-weight:800; font-size:.85rem; line-height:24px; text-align:center; transition:width .6s ease; letter-spacing:.2px; }
    .score-label{ position:absolute; inset:0; display:grid; place-items:center; font-weight:800; color:#111827; font-size:.85rem; pointer-events:none; }

    /* Barras coloreadas por estado */
    .fill-ok  { background: linear-gradient(90deg, hsl(var(--ok-hsl) / .85),  hsl(var(--ok-hsl) / .65)); }
    .fill-bad { background: linear-gradient(90deg, hsl(var(--bad-hsl)/ .85),  hsl(var(--bad-hsl)/ .65)); }

    .me-ok{ background:#e8f7ee !important; outline:2px solid var(--ok); }
    .me-bad{ background:#fde8e8 !important; outline:2px solid var(--bad); }

    /* ====== MÓVIL: vista compacta y sin sidebar ====== */
    @media (max-width: 900px){
      /* 1) Layout: sidebar fuera, selector arriba */
      .layout{ grid-template-columns: 1fr !important; }
      .side{ display:none !important; }
      .mobile-picker{ display:flex !important; align-items:center; gap:8px; margin:6px 0 10px; }
      .mobile-picker select{
        padding:8px 10px; border:1px solid #e8eaf0; border-radius:10px; background:#fff; font-size:.95rem;
      }

      /* 2) Tarjeta y cabecera más contenidas */
      .card{ padding:14px !important; border-radius:16px !important; }
      .header{ margin-bottom:8px !important; }
      .header .title h2{ font-size:1.15rem !important; }
      .chips, .tone-toggle{ display:none !important; }  /* quita chips y el toggle de color en móvil */

      /* 3) Tabla compacta (seguimos en tabla, no en cards) */
      thead{ display: table-header-group !important; }
      table{ display: table !important; width:100% !important; table-layout: fixed; }
      tbody{ display: table-row-group !important; }
      tr   { display: table-row !important; }
      td, th{ display: table-cell !important; }

      thead th{
        font-size:.68rem !important; letter-spacing:.08em !important; color:#64748b !important;
        padding:6px 6px !important; text-transform:uppercase;
      }
      tbody td{ padding:8px 6px !important; vertical-align: middle !important; }

      /* 4) Columnas y elementos pequeños */
      .pos{ width:32px !important; font-size:.9rem !important; font-weight:700 !important; }
      .user{ gap:.45rem !important; }
      .avatar-wrap{ width:22px !important; height:22px !important; margin-right:.2rem !important; }
      .avatar{ width:22px !important; height:22px !important; font-size:.7rem !important; }
      .badge{ width:12px !important; height:12px !important; font-size:.9rem !important; right:-3px !important; bottom:-3px !important; }
      .you{ font-size:.65rem !important; padding:.12rem .4rem !important; }

      /* 5) Barra finita y número opcional a la derecha */
      .scorebar{ height:8px !important; border-radius:999px !important; }
      .fill{ line-height:8px !important; font-size:0 !important; }
      .score-label{ display:none !important; } /* oculta número sobre la barra */

      /* si quieres ver el número a la derecha de la barra: */
      td:last-child{ display:flex; align-items:center; gap:6px; }
      td:last-child .scorebar{ flex:1; }
      td:last-child::after{
        content: attr(data-score);   /* <- ver nota abajo */
        font-weight:700; font-size:.85rem; color:#111827;
      }

      @media (max-width: 900px){

      /* Asegura que los anchos de columna se respetan */
      table{ table-layout: fixed !important; width:100%; }

      /* 1) Reparto de columnas (sin tocar la plantilla) */
      thead th:nth-child(1),
      tbody td:nth-child(1){ width: 32px !important; }      /* POS más estrecha */
      thead th:nth-child(2),
      tbody td:nth-child(2){ width: auto !important; }       /* NOMBRE ocupa lo que haga falta */
      thead th:nth-child(3),
      tbody td:nth-child(3){ width: 40% !important; }        /* PUNTUACIÓN algo más ancha */

      /* 2) Tipos de letra más pequeños */
      .pos{ font-size: .85rem !important; font-weight:350; } /* número de posición */
      .user > span:nth-child(2){ font-size: .65rem !important; } /* NOMBRE (2º span tras el avatar) */
      .you{ font-size: .65rem !important; padding: .1rem .38rem !important; } /* chip TÚ */

      /* 3) Puntuación más pequeña (número y barra) */
      .scorebar{ height: 10px !important; }
      .fill{ line-height: 10px !important; font-size: 0 !important; } /* oculta nº dentro de la barra */
      .score-label{ font-size: .8rem !important; }  /* si aún muestras el número encima de la barra */

      /* Si usas el truco del número a la derecha con data-score */
      td:last-child::after{ font-size: .82rem !important; font-weight:700; color:#111827; }
      .score-label{ display:grid !important; font-size:.4rem !important; }
      }
      /* === Móvil: mostrar el número y que se lea bien === */
    @media (max-width: 900px){
      /* 1) vuelve a mostrar el número dentro de la barra */
      .fill{
        font-size: .82rem !important;           /* antes lo teníamos a 0 */
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        color: #fff !important;                  /* texto blanco sobre verde/rojo */
      }

      /* 2) si usas el overlay cuando la barra es pequeña (pct<18), no lo ocultes */
      .score-label{
        display: grid !important;                /* vuelve a mostrarse en móvil */
        font-size: .8rem !important;
        color: #111827 !important;               /* negro/gris oscuro sobre fondo claro */
      }

      /* 3) barra algo más alta para que quepa el número sin apretarlo */
      .scorebar{ height: 12px !important; }
    }

    /* Por si tienes clases de color diferenciadas, fuerza contraste igual: */
    .fill-ok, .fill-bad{ color:#fff !important; }

    
    }


  </style>
</head>
<body class="tone-soft"><!-- cambia a tone-strong para colores más vivos -->
  <div class="card">
    {% set grupo_sel = (grupos_usuario | selectattr('id','equalto', id_grupo) | list | first) %}
    {% set max_p = (resultados | map(attribute='puntuacion') | max) if resultados else 1 %}
    {% set total_part = resultados|length if resultados else 0 %}
    {% set tu_fila = (resultados | selectattr('id_usuario','equalto', session['usuario_id']) | list | first) %}
    {% set tu_ok = (tu_fila.correcta == 1) if tu_fila is defined and tu_fila else none %}

    <div class="layout">
      <!-- SIDEBAR IZQUIERDA -->
      <aside class="side">
        <h3><i class="fa-solid fa-layer-group"></i> Tus grupos</h3>
        {% if grupos_usuario and grupos_usuario|length %}
          <ul class="glist">
            {% for g in grupos_usuario %}
              <li class="gitem {% if g.id == id_grupo %}active{% endif %}">
                <a href="{{ url_for('resultados.ver_resultados', id_grupo=g.id) }}">
                  <span class="dot"></span>
                  <span style="font-weight:700">{{ g.codigo }}</span>
                </a>
              </li>
            {% endfor %}
          </ul>
          <div class="mini-actions">
            <a href="{{ url_for('grupos.crear_grupo') }}"><i class="fa-solid fa-plus"></i> Crear</a>
            <a href="{{ url_for('grupos.unirse_grupo') }}"><i class="fa-solid fa-sign-in-alt"></i> Unirse</a>
          </div>
        {% else %}
          <p class="meta">No perteneces a ningún grupo.</p>
          <div class="mini-actions">
            <a href="{{ url_for('grupos.crear_grupo') }}">Crear grupo</a>
            <a href="{{ url_for('grupos.unirse_grupo') }}">Unirse a grupo</a>
          </div>
        {% endif %}
      </aside>

      <!-- CONTENIDO PRINCIPAL -->
      <section class="main">
        <!-- Selector móvil (fallback) -->
        <form class="mobile-picker" method="GET" action="{{ url_for('resultados.ver_resultados') }}">
          <label for="id_grupo"><strong>Grupo:</strong></label>
          <select name="id_grupo" id="id_grupo" onchange="this.form.submit()">
            {% for g in grupos_usuario %}
              <option value="{{ g.id }}" {% if g.id == id_grupo %}selected{% endif %}>{{ g.codigo }}</option>
            {% endfor %}
          </select>
          <noscript><button type="submit">Ver</button></noscript>
        </form>

        <div class="header">
          <div class="title">
            <h2>📊 Clasificación</h2>
          </div>
          <div class="chips">
            {% if grupo_sel %}<span class="chip"><i class="fa-solid fa-users"></i> Grupo: <strong>{{ grupo_sel.codigo }}</strong></span>{% endif %}
            <span class="chip"><i class="fa-solid fa-user-group"></i> {{ total_part }} participantes</span>
            <span class="chip"><i class="fa-solid fa-trophy"></i> Máx: {{ max_p }}</span>
            {% if tu_fila %}
              {% if tu_ok %}
                <span class="chip" style="background:#e7f7ef;color:#14532d;border-color:#cdebd8">
                  <i class="fa-solid fa-check-circle"></i> Tu estado: Correcto
                </span>
              {% else %}
                <span class="chip" style="background:#fde8e8;color:#7f1d1d;border-color:#f5c2c2">
                  <i class="fa-solid fa-xmark-circle"></i> Tu estado: Incorrecto
                </span>
              {% endif %}
            {% endif %}
          </div>
        </div>
        
        <div class="toolbar">
          <a class="btn-link" href="{{ url_for('index') }}"><i class="fa-solid fa-arrow-left"></i> Volver al inicio</a>

          <!-- Toggle de tono -->
          <div class="tone-toggle" aria-label="Ajuste de color">
            <button type="button" id="btnSoft" class="active">Suave</button>
            <button type="button" id="btnStrong">Vivo</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th style="width:72px;">Pos</th>
              <th>Nombre</th>
              <th>Puntuación</th>
            </tr>
          </thead>
          <tbody>
            {% for r in resultados %}
              {% set pos = loop.index %}
              {% set is_you = (r.id_usuario == session['usuario_id']) %}
              {% set row_class = 'me-ok' if is_you and r.correcta==1 else ('me-bad' if is_you and r.correcta==0 else '') %}

              <tr class="{{ row_class }}">
                <td class="pos">{{ pos }}</td>

                <td class="user">
                  <span class="avatar-wrap">
                    <span class="avatar {% if r.correcta==1 %}ok{% elif r.correcta==0 %}bad{% else %}unk{% endif %}">
                      {{ (r.usuario[:1] if r.usuario else '?')|upper }}
                    </span>
                    {% if r.correcta==1 %}
                      <span class="badge ok" title="Correcto"><i class="fa-solid fa-check"></i></span>
                    {% elif r.correcta==0 %}
                      <span class="badge bad" title="Incorrecto"><i class="fa-solid fa-xmark"></i></span>
                    {% else %}
                      <span class="badge unk" title="Sin responder">—</span>
                    {% endif %}
                  </span>
                  <span style="font-weight:700">{{ r.usuario }}</span>
                  {% if is_you %}<span class="you">TÚ</span>{% endif %}
                </td>

                <td>
                  <div class="scorebar" title="Puntuación: {{ r.puntuacion }}">
                    {% set pct = (r.puntuacion / (max_p if max_p else 1) * 100) | round(0) %}
                    {% if pct <= 0 %}
                      <div class="fill {% if r.correcta==1 %}fill-ok{% elif r.correcta==0 %}fill-bad{% endif %}" style="width:0%"></div>
                      <div class="score-label">0</div>
                    {% elif pct < 18 %}
                      <div class="fill {% if r.correcta==1 %}fill-ok{% elif r.correcta==0 %}fill-bad{% endif %}" style="width: {{ pct }}%"></div>
                      <div class="score-label">{{ r.puntuacion }}</div>
                    {% else %}
                      <div class="fill {% if r.correcta==1 %}fill-ok{% elif r.correcta==0 %}fill-bad{% endif %}" style="width: {{ pct }}%">{{ r.puntuacion }}</div>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>

        {% if not resultados %}
          <p class="meta" style="margin-top:14px">Aún no hay resultados para este grupo.</p>
        {% endif %}
      </section>
    </div>
  </div>

  <script>
    // Toggle de tono con persistencia
    (function(){
      const body = document.body;
      const btnSoft = document.getElementById('btnSoft');
      const btnStrong = document.getElementById('btnStrong');

      function setTone(mode){
        body.classList.remove('tone-soft','tone-strong');
        body.classList.add(mode);
        localStorage.setItem('toneMode', mode);
        btnSoft.classList.toggle('active', mode === 'tone-soft');
        btnStrong.classList.toggle('active', mode === 'tone-strong');
      }

      // Cargar preferencia guardada
      const saved = localStorage.getItem('toneMode');
      if (saved === 'tone-strong') setTone('tone-strong'); // por defecto viene 'tone-soft' en <body>

      btnSoft.addEventListener('click', () => setTone('tone-soft'));
      btnStrong.addEventListener('click', () => setTone('tone-strong'));
    })();
  </script>
</body>
</html>
