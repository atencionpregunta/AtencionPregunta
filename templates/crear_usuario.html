{% extends "base.html" %}
{% set body_class = 'app-shell tone-soft page-auth' %}
{% block title %}Crear Usuario · Reto Diario{% endblock %}

{% block content %}
  <!-- Header -->
  <header class="flex items-center justify-between mb-4">
    <a href="{{ url_for('auth.login_form') }}"
       class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-rose-100 bg-white hover:bg-neutral-50 text-sm">
      <i class="fa-solid fa-arrow-left"></i> Volver
    </a>
    <h2 class="text-xl sm:text-2xl font-extrabold text-brand">
      <i class="fa-solid fa-user-plus"></i> Crear usuario
    </h2>
  </header>

  <!-- Chip info -->
  <div class="mb-3">
    <span class="inline-flex items-center gap-2 text-sm px-3 py-1.5 rounded-full bg-white border border-rose-100">
      <i class="fa-solid fa-shield-halved"></i> Revisión de disponibilidad en vivo
    </span>
  </div>

  <!-- Flashes -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2 mb-4">
        {% for category, message in messages %}
          {% set cls = 'bg-emerald-50 text-emerald-800 border-emerald-200' if category=='success'
                      else ('bg-red-50 text-red-800 border-red-200' if category in ['error','danger']
                      else 'bg-blue-50 text-blue-800 border-blue-200') %}
          <div class="px-4 py-2 rounded-xl border {{ cls }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Form -->
  <form method="POST"
        action="{{ url_for('auth.crear_usuario') }}"
        id="form-crear-usuario"
        novalidate
        x-data="{ usuarioOK:false, mailOK:false, passOK:false }"
        class="space-y-4">

    <!-- Usuario -->
    <div>
      <label for="usuario" class="block font-semibold text-sm mb-1">Nombre de usuario</label>
      <input id="usuario" name="usuario" type="text" required autocomplete="off"
             value="{{ request.form.get('usuario','') }}"
             class="w-full h-11 px-4 rounded-full border border-rose-100 bg-white shadow-sm focus:outline-none focus:ring-4 focus:ring-rose-300"
             placeholder="p.ej. iker_l">
      <div id="usuario_hint" class="text-sm mt-1 text-neutral-600">Elige tu nombre de usuario.</div>
    </div>

    <!-- Email -->
    <div>
      <label for="mail" class="block font-semibold text-sm mb-1">Email</label>
      <input id="mail" name="mail" type="email" required autocomplete="off"
             value="{{ request.form.get('mail','') }}"
             class="w-full h-11 px-4 rounded-full border border-rose-100 bg-white shadow-sm focus:outline-none focus:ring-4 focus:ring-rose-300"
             placeholder="tucorreo@dominio.com">
      <div id="mail_hint" class="text-sm mt-1 text-neutral-600">Introduce tu email.</div>
    </div>

    <!-- Contraseña -->
    <div x-data="{show:false}">
      <label for="contrasena" class="block font-semibold text-sm mb-1">Contraseña</label>
      <div class="relative">
        <input :type="show ? 'text' : 'password'"
               id="contrasena" name="contrasena" required
               class="w-full h-11 pl-4 pr-11 rounded-full border border-rose-100 bg-white shadow-sm focus:outline-none focus:ring-4 focus:ring-rose-300"
               placeholder="mínimo 4 caracteres">
        <button type="button" @click="show=!show"
                class="absolute inset-y-0 right-0 px-3 text-neutral-600 hover:text-neutral-900"
                aria-label="Mostrar u ocultar contraseña">
          <i class="fa-solid" :class="show ? 'fa-eye-slash' : 'fa-eye'"></i>
        </button>
      </div>
      <div id="pass_hint" class="text-sm mt-1 text-neutral-600">Mínimo 4 caracteres.</div>
    </div>

    <!-- Acciones -->
    <div class="grid gap-2 sm:grid-cols-[1fr_auto] mt-2">
      <button id="btn-crear" type="submit"
              :disabled="!(usuarioOK && mailOK && passOK)"
              class="inline-flex items-center justify-center gap-2 px-5 h-11 rounded-full text-white
                     bg-gradient-to-tr from-brand to-brand-dark shadow-md hover:shadow-lg transition
                     disabled:opacity-50 disabled:cursor-not-allowed">
        <i class="fa-solid fa-check"></i> Crear usuario
      </button>
      <a href="{{ url_for('auth.login_form') }}"
         class="inline-flex items-center justify-center gap-2 px-4 h-11 rounded-full border border-rose-100 bg-white hover:bg-neutral-50">
        <i class="fa-solid fa-arrow-left"></i> Volver
      </a>
    </div>
  </form>
{% endblock %}

{% block scripts %}
<script>
(() => {
  const form   = document.getElementById('form-crear-usuario');
  const $u     = document.getElementById('usuario');
  const $uHint = document.getElementById('usuario_hint');
  const $m     = document.getElementById('mail');
  const $mHint = document.getElementById('mail_hint');
  const $p     = document.getElementById('contrasena');
  const $pHint = document.getElementById('pass_hint');
  const $btn   = document.getElementById('btn-crear');   // <- asegúrate de que el botón tiene este id

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const debounce = (fn, d=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); }; };

  // ===== Alpine helpers (v2/v3) + fallback =====
  const getAlpineData = () => {
    if (!form) return null;
    // v3
    if (form._x_dataStack && form._x_dataStack.length) return form._x_dataStack[0];
    // v2
    if (form.__x && form.__x.$data) return form.__x.$data;
    return null;
  };
  const setAlpine = (key, val) => {
    const d = getAlpineData();
    if (d) d[key] = val;
    recompute();   // <- cada vez que cambie una bandera, reevalúa el botón
  };
  const recompute = () => {
    const d = getAlpineData();
    if ($btn) {
      // si hay Alpine, respeta su estado; si no, usa estas flags en fallback
      const uOK = d ? !!d.usuarioOK : ($uHint?.className.includes('text-emerald-600'));
      const mOK = d ? !!d.mailOK    : ($mHint?.className.includes('text-emerald-600'));
      const pOK = d ? !!d.passOK    : ($pHint?.className.includes('text-emerald-600'));
      $btn.disabled = !(uOK && mOK && pOK);
    }
  };

  // ===== Usuario =====
  const checkUsuario = debounce(async () => {
    const v = ($u.value || "").replace(/\s+/g,' ').trim();
    $u.value = v;
    if(!v){
      $uHint.textContent = "Elige tu nombre de usuario.";
      $uHint.className = "text-sm mt-1 text-neutral-600";
      setAlpine('usuarioOK', false); return;
    }
    $uHint.textContent = "Comprobando disponibilidad…";
    $uHint.className = "text-sm mt-1 text-neutral-600";
    try{
      const url = new URL("{{ url_for('auth.check_usuario') }}", window.location.origin);
      url.searchParams.set("usuario", v);
      const res = await fetch(url, { credentials: "same-origin" });
      const data = await res.json();
      if(data.available){
        $uHint.textContent = "Nombre disponible ✔";
        $uHint.className = "text-sm mt-1 text-emerald-600";
        setAlpine('usuarioOK', true);
      } else {
        $uHint.textContent = "Ese usuario ya existe.";
        $uHint.className = "text-sm mt-1 text-red-600";
        setAlpine('usuarioOK', false);
      }
    } catch {
      $uHint.textContent = "No se pudo comprobar ahora.";
      $uHint.className = "text-sm mt-1 text-red-600";
      setAlpine('usuarioOK', false);
    }
  }, 350);

  // ===== Mail =====
  const checkMail = debounce(async () => {
    const v = ($m.value || "").trim();
    if(!v){
      $mHint.textContent = "Introduce tu email.";
      $mHint.className = "text-sm mt-1 text-neutral-600";
      setAlpine('mailOK', false); return;
    }
    if(!emailRegex.test(v)){
      $mHint.textContent = "Formato de email no válido.";
      $mHint.className = "text-sm mt-1 text-red-600";
      setAlpine('mailOK', false); return;
    }
    $mHint.textContent = "Comprobando disponibilidad…";
    $mHint.className = "text-sm mt-1 text-neutral-600";
    try{
      const url = new URL("{{ url_for('auth.check_mail') }}", window.location.origin);
      url.searchParams.set("mail", v);
      const res = await fetch(url, { credentials: "same-origin" });
      const data = await res.json();
      if(data.available){
        $mHint.textContent = "Email disponible ✔";
        $mHint.className = "text-sm mt-1 text-emerald-600";
        setAlpine('mailOK', true);
      } else {
        $mHint.textContent = "Ese email ya está en uso.";
        $mHint.className = "text-sm mt-1 text-red-600";
        setAlpine('mailOK', false);
      }
    } catch {
      $mHint.textContent = "No se pudo comprobar ahora.";
      $mHint.className = "text-sm mt-1 text-red-600";
      setAlpine('mailOK', false);
    }
  }, 350);

  // ===== Password =====
  const checkPass = () => {
    const v = $p.value || "";
    if(v.length >= 4){
      $pHint.textContent = "OK ✔";
      $pHint.className = "text-sm mt-1 text-emerald-600";
      setAlpine('passOK', true);
    } else {
      $pHint.textContent = "Mínimo 4 caracteres.";
      $pHint.className = "text-sm mt-1 text-neutral-600";
      setAlpine('passOK', false);
    }
  };

  // Listeners
  $u.addEventListener('input', checkUsuario);
  $m.addEventListener('input', checkMail);
  $p.addEventListener('input', checkPass);

  // Spinner en submit
  if (form) {
    form.addEventListener('submit', () => {
      if($btn){
        $btn.insertAdjacentHTML('beforeend',
          '<span class="ml-2 inline-block w-4 h-4 border-2 border-white border-r-transparent rounded-full animate-spin"></span>');
      }
    });
  }

  // Estado inicial
  setAlpine('usuarioOK', false);
  setAlpine('mailOK', false);
  setAlpine('passOK', false);
  recompute();
})();
</script>

{% endblock %}
