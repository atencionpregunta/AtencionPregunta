<!doctype html>
<html lang="es" class="h-full">

<head>
  <meta charset="utf-8" />
  <title>{% block title %}Reto Diario{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- en base.html, antes de </head> o justo antes de </body> -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    [x-cloak] {
      display: none !important
    }
  </style>



  <!-- Fuente e iconos -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='img/ATPPet-32.png') }}" />
  <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='img/ATPPet-16.png') }}" />
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/ATPPet-180.png') }}" />

  <!-- Tailwind por CDN (rápido para empezar) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            brand: { DEFAULT: '#ef4444', dark: '#dc2626' }
          },
          borderRadius: { '2xl': '1.25rem' }
        }
      }
    }
  </script>

  <!-- Alpine (estado ligero) -->
  <script defer src="https://unpkg.com/alpinejs"></script>
  <!-- HTMX (interacciones sin recarga) -->
  <script defer src="https://unpkg.com/htmx.org@1.9.12"></script>

  {% block extra_head %}{% endblock %}
</head>

<body class="{{ body_class|default('') }} h-full bg-gradient-to-b from-rose-300 via-rose-200 to-white text-neutral-900">
  <div class="min-h-screen flex flex-col">

    <!-- NAV superior -->
    <!-- Añade en <head> si no lo tienes -->
    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>

    <!-- NAV superior -->
    <header class="sticky top-0 z-40 backdrop-blur bg-white/40 border-b border-white/50">
      <nav class="max-w-6xl mx-auto px-4 sm:px-6 py-2.5 flex items-center justify-between">
        <!-- Marca -->
        <a href="{{ url_for('index') }}" class="flex items-center gap-2 font-extrabold tracking-wide text-brand">
          <img src="{{ url_for('static', filename='img/ATPPet-32.png') }}" class="w-6 h-6" alt="Logo">
          <span>Atención Pregunta</span>
        </a>

        <!-- Lado derecho -->
        <div class="flex items-center">
          {% if session.get('usuario_id') %}
          <!-- Menú de usuario (Alpine) -->
          <div x-data="{ open:false }" class="relative">
            <button @click="open=!open" @keydown.escape.window="open=false" :aria-expanded="open" aria-haspopup="true"
              aria-controls="userMenu"
              class="inline-flex items-center gap-2 pl-2 pr-3 py-1.5 rounded-full hover:bg-white/70 focus:outline-none focus:ring-2 focus:ring-rose-300"
              title="Menú">
              <!-- Avatar con inicial -->
              <span
                class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-rose-500 text-white font-bold">
                {{ ((session.get('usuario_nombre') or 'U')|string)[0]|upper }}
              </span>
              <svg class="w-4 h-4 opacity-80" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M7 10l5 5 5-5H7z"></path>
              </svg>
              <span class="sr-only">Abrir menú de usuario</span>
            </button>

            <!-- Dropdown -->
            <div x-cloak x-show="open" x-transition.origin.top.right @click.outside="open=false" id="userMenu"
              role="menu" aria-label="Menú de usuario"
              class="absolute right-0 mt-2 w-48 rounded-2xl border border-rose-100 bg-white shadow-xl overflow-hidden">
              <a role="menuitem" href="{{ url_for('grupos.gestionar_grupos') }}"
                class="block px-4 py-2.5 text-sm hover:bg-rose-50">Grupos</a>
              <a role="menuitem" href="{{ url_for('resultados.ver_resultados') }}"
                class="block px-4 py-2.5 text-sm hover:bg-rose-50">Resultados</a>

              <!-- Divider -->
              <div class="my-1 border-t border-rose-100"></div>

              <!-- Salir (GET o POST según tu backend) -->
              {# Opción A: enlace GET #}
              <a role="menuitem" href="{{ url_for('auth.logout') }}"
                class="block px-4 py-2.5 text-sm text-red-600 hover:bg-rose-50">Salir</a>

              {# Opción B: formulario POST (recomendado si tienes CSRF) #
              <form role="none" action="{{ url_for('auth.logout') }}" method="post">
                <button type="submit" class="w-full text-left px-4 py-2.5 text-sm text-red-600 hover:bg-rose-50">
                  Salir
                </button>
              </form>
              #}
            </div>
          </div>
          {% else %}
          <!-- Si no está logueado: botón Entrar -->
          <a href="{{ url_for('auth.login') }}"
            class="px-3 py-1.5 rounded-full bg-brand text-white hover:bg-brand-dark text-sm">Entrar</a>
          {% endif %}
        </div>
      </nav>
    </header>


    <!-- CONTENIDO centrado -->
    <main class="flex-1 px-3 sm:px-4">
      <div class="max-w-3xl mx-auto py-6 sm:py-10">
        <!-- Card contenedora por defecto -->
        <div
          class="bg-white/90 backdrop-blur border border-rose-100 shadow-xl shadow-rose-100/50 rounded-2xl p-5 sm:p-7">
          {% block content %}{% endblock %}
        </div>
      </div>
    </main>

    <!-- FOOTER simple -->
    <footer class="py-6 text-center text-sm text-neutral-600">
      © {{ now().year }} Atención Pregunta · Hecho con Flask · HTMX · Alpin
    </footer>
  </div>

  <!-- BOTÓN DE AYUDA flotante (Alpine) -->
  <div x-data="{open:false}" class="fixed left-3 bottom-3 z-50">
    <button @click="open=!open"
      class="w-12 h-12 rounded-full bg-white text-brand border border-rose-200 shadow-lg hover:shadow-xl">
      <i class="fa-solid fa-question"></i>
    </button>
    <div x-show="open" x-transition
      class="mt-3 w-80 max-w-[92vw] bg-white rounded-2xl border border-rose-100 shadow-2xl p-4">
      <div class="font-extrabold text-brand mb-1">Ayuda rápida</div>
      <p class="text-sm text-neutral-600">
        Si algo no carga, prueba actualizar. Las respuestas se envían sin recargar gracias a HTMX.
      </p>
      <div class="mt-3 flex justify-end">
        <button @click="open=false"
          class="px-3 py-1.5 rounded-full bg-neutral-900 text-white text-sm">Entendido</button>
      </div>
    </div>
  </div>

  <!-- ZONA DE TOASTS -->
  <div id="toasts" class="fixed top-3 right-3 z-50 space-y-2"></div>

  {% block floating %}{% endblock %}

  <!-- Helpers comunes -->
  <script>
    // Toast mínimo: úsalo desde tus vistas con HTMX mediante hx-trigger="revealed" + hx-get a un endpoint que devuelva JS,
    // o llama window.toast('texto','ok'|'bad'|'info')
    window.toast = function (msg, kind = 'ok') {
      const host = document.getElementById('toasts');
      const el = document.createElement('div');
      const base = 'px-4 py-2 rounded-xl shadow-lg text-sm text-white';
      const cls = kind === 'bad' ? 'bg-red-600' : (kind === 'info' ? 'bg-blue-600' : 'bg-emerald-600');
      el.className = base + ' ' + cls;
      el.textContent = msg;
      host.appendChild(el);
      setTimeout(() => { el.classList.add('opacity-0', 'transition'); }, 2800);
      setTimeout(() => { host.removeChild(el); }, 3200);
    };

    // Integración básica con HTMX para toasts por cabeceras
    document.body.addEventListener('htmx:afterOnLoad', (e) => {
      const ok = e.detail.xhr.getResponseHeader('X-Toast-Ok');
      const bad = e.detail.xhr.getResponseHeader('X-Toast-Bad');
      if (ok) toast(ok, 'ok');
      if (bad) toast(bad, 'bad');
    });
  </script>

  {% block scripts %}{% endblock %}
</body>

</html>