{% extends "base.html" %}
{% set body_class = 'app-shell tone-soft page-grupos' %}
{% block title %}Unirse a Grupo · Reto Diario{% endblock %}

{% block content %}
<header class="header">
  <div class="title">
    <a class="btn-link" href="{{ url_for('index') }}" title="Volver al inicio">
      <i class="fa-solid fa-arrow-left"></i>
    </a>
    <h2><i class="fa-solid fa-users"></i> Unirse a grupo</h2>
  </div>
  <div class="chips">
    <span class="chip"><i class="fa-solid fa-globe"></i> Explora públicos</span>
  </div>
</header>

<div class="form-shell">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="POST" action="{{ url_for('grupos.unirse_grupo') }}">
    <div class="form-row">
      <label for="codigo_grupo"><strong>Nombre o código del grupo</strong></label>
      <input class="input" type="text" name="codigo_grupo" id="codigo_grupo" required>
    </div>
    <div class="form-row">
      <label for="contrasena_grupo"><strong>Contraseña (si tiene)</strong></label>
      <input class="input" type="password" name="contrasena_grupo" id="contrasena_grupo">
    </div>

<button type="submit" class="primary-btn primary-btn--full">
  <i class="fa-solid fa-door-open"></i> Unirse al grupo
</button>


  </form>

  <!-- Explorador de grupos públicos -->
  <div class="publicos">
    <h3><i class="fa-solid fa-globe"></i> Grupos públicos</h3>

    <div class="publicos__search">
      <input class="input" type="text" id="search_publicos" placeholder="Buscar grupo público…" autocomplete="off">
    </div>

    <table class="publicos-table">
      <colgroup>
        <col style="width:40%">
        <col style="width:30%">
        <col style="width:30%">
      </colgroup>
      <thead>
        <tr>
          <th>Grupo</th>
          <th>Miembros</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="publicos_list">
        <tr><td colspan="3" class="hint neutral">Escribe para buscar…</td></tr>
      </tbody>
    </table>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const formJoin    = document.querySelector('form[action="{{ url_for("grupos.unirse_grupo") }}"]');
  const inputCodigo = document.getElementById("codigo_grupo");
  const listEl      = document.getElementById("publicos_list");
  const qInput      = document.getElementById("search_publicos");
  const LIST_URL    = "{{ url_for('grupos.listar_publicos') }}";

  function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

  function renderLista(items){
    if (!listEl) return;
    if (!items.length){
      listEl.innerHTML = '<tr><td colspan="3" class="hint neutral">No hay resultados.</td></tr>';
      return;
    }
    listEl.innerHTML = items.map(g => {
      const nombre = escapeHtml(g.codigo);
      const n = Number(g.miembros ?? 0);
      return `
        <tr>
          <td>${nombre}</td>
          <td style="text-align:center; white-space:nowrap;">${n}</td>
          <td style="text-align:right;">
            <button type="button" class="primary-btn btn-sm join-btn" data-code="${nombre}">Unirse</button>
          </td>
        </tr>`;
    }).join("");
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.join-btn');
    if (!btn) return;
    inputCodigo.value = btn.dataset.code || '';
    formJoin.submit();
  });

  function debounce(fn, delay=300){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), delay); }; }

  let aborter = null;
  async function cargarPublicos(q=""){
    if (!listEl) return;
    if (aborter) aborter.abort();
    aborter = new AbortController();

    listEl.innerHTML = '<tr><td colspan="3" class="hint neutral">Buscando…</td></tr>';

    try{
      const url = new URL(LIST_URL, window.location.origin);
      if (q.trim()) url.searchParams.set("q", q.trim());
      url.searchParams.set("limit", "25");
      const res = await fetch(url.toString(), { credentials:"same-origin", signal: aborter.signal });
      if (!res.ok) throw new Error("HTTP "+res.status);
      const data = await res.json();
      renderLista(data.items || []);
    }catch(e){
      if (e.name === 'AbortError') return;
      listEl.innerHTML = '<tr><td colspan="3" class="hint bad">Error al cargar grupos.</td></tr>';
      console.error(e);
    }
  }

  const debounced = debounce(() => cargarPublicos(qInput.value), 300);
  qInput.addEventListener('input', debounced);
  qInput.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); cargarPublicos(qInput.value); }});

  cargarPublicos("");
})();
</script>
{% endblock %}
