{% extends "base.html" %}
{% set body_class = 'app-shell tone-soft page-grupos' %}
{% block title %}Unirse a Grupo · Reto Diario{% endblock %}

{% block content %}
  <!-- Header -->
  <header class="flex items-center justify-between mb-4">
    <a href="{{ url_for('index') }}"
       class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-rose-100 bg-white hover:bg-neutral-50 text-sm">
      <i class="fa-solid fa-arrow-left"></i> Volver
    </a>
    <h2 class="text-xl sm:text-2xl font-extrabold text-brand">
      <i class="fa-solid fa-users"></i> Unirse a grupo
    </h2>
  </header>

  <!-- Flashes -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2 mb-4">
        {% for category, message in messages %}
          {% set cls = 'bg-emerald-50 text-emerald-800 border-emerald-200' if category=='success'
                      else ('bg-red-50 text-red-800 border-red-200' if category in ['error','danger']
                      else 'bg-blue-50 text-blue-800 border-blue-200') %}
          <div class="px-4 py-2 rounded-xl border {{ cls }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div x-data="unirseGrupo()" x-init="init()" class="max-w-5xl mx-auto">
    <!-- Filter bar -->
    <div class="bg-white/90 backdrop-blur border border-rose-100 rounded-2xl p-4 shadow-sm mb-3">
      <div class="grid gap-3 sm:grid-cols-2">
        <div>
          <label class="block font-semibold text-sm mb-1">Tipo</label>
          <select x-model="f_tipo"
                  @change="apply()"
                  class="w-full h-11 px-3 rounded-xl border border-neutral-200 bg-white focus:outline-none focus:ring-4 focus:ring-rose-300">
            <option value="">Todos</option>
            <option value="publico">Público</option>
            <option value="privado">Privado</option>
          </select>
        </div>
        <div>
          <label class="block font-semibold text-sm mb-1">Ordenar por</label>
          <select x-model="f_sort"
                  @change="apply()"
                  class="w-full h-11 px-3 rounded-xl border border-neutral-200 bg-white focus:outline-none focus:ring-4 focus:ring-rose-300">
            <option value="miembros_desc">Miembros ↓</option>
            <option value="miembros_asc">Miembros ↑</option>
            <option value="duracion_asc">Duración ↑</option>
            <option value="duracion_desc">Duración ↓</option>
          </select>
        </div>
        <div class="sm:col-span-2">
          <label class="block font-semibold text-sm mb-1">Búsqueda</label>
          <input x-model.trim="f_q"
                 @input="applyDebounced()"
                 type="text" autocomplete="off" placeholder="Buscar por nombre o código…"
                 class="w-full h-11 px-3 rounded-xl border border-neutral-200 bg-white focus:outline-none focus:ring-4 focus:ring-rose-300" />
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="overflow-x-auto bg-white border border-rose-100 rounded-2xl">
      <table class="min-w-full">
        <colgroup>
          <col class="w-[54%] sm:w-[60%]">
          <col class="w-[16%] sm:w-[15%]">
          <col class="w-[16%] sm:w-[17%]">
          <col class="w-[14%] sm:w-[8%]">
        </colgroup>
        <thead class="bg-neutral-50 border-b border-rose-100">
          <tr class="text-left text-xs font-extrabold tracking-wide uppercase text-neutral-500">
            <th class="px-3 py-2.5">Grupo</th>
            <th class="px-3 py-2.5">Miembros</th>
            <th class="px-3 py-2.5">Duración</th>
            <th class="px-3 py-2.5 text-right hidden sm:table-cell"></th>
          </tr>
        </thead>
        <tbody>
          <!-- Estado / vacío -->
          <template x-if="state==='loading'">
            <tr><td colspan="4" class="px-3 py-4 text-center text-neutral-600">Cargando…</td></tr>
          </template>
          <template x-if="state==='error'">
            <tr><td colspan="4" class="px-3 py-4 text-center text-red-700">No se pudo cargar la lista.</td></tr>
          </template>
          <template x-if="state==='ok' && rows.length===0">
            <tr><td colspan="4" class="px-3 py-4 text-center text-neutral-600">Sin resultados.</td></tr>
          </template>

          <!-- Filas -->
          <template x-for="g in rows" :key="g.codigo">
            <tr class="border-b border-rose-50 hover:bg-neutral-50 text-sm"
                :data-code="g.codigo" :data-tipo="g._tipo"
                @click="onRowClick($event, g)">
              <td class="px-3 py-2.5">
                <div class="flex items-center gap-2 font-semibold">
                  <span class="inline-grid place-items-center w-7 h-7 rounded-full border"
                        :class="g._tipo==='privado' ? 'text-red-700 bg-rose-50 border-rose-200' : 'text-blue-700 bg-blue-50 border-blue-200'">
                    <i class="fa-solid" :class="g._tipo==='privado' ? 'fa-lock' : 'fa-unlock'"></i>
                  </span>
                  <span class="truncate" x-text="g.codigo"></span>
                  <span class="hidden sm:inline text-[.68rem] font-extrabold px-2 py-0.5 rounded-full border border-neutral-200 bg-neutral-50 text-neutral-600"
                        x-text="g._tipo==='privado' ? 'Privado' : 'Público'"></span>
                </div>
              </td>
              <td class="px-3 py-2.5 font-bold text-neutral-800" x-text="g._miem"></td>
              <td class="px-3 py-2.5">
                <div class="inline-flex items-center gap-2">
                  <div class="hidden sm:block relative h-2 w-24 rounded-full bg-neutral-200 overflow-hidden">
                    <div class="absolute inset-y-0 left-0 rounded-full"
                         :style="`width:${g._pct}%;`"
                         :class="g._estado==='done' ? 'bg-red-500' : (g._estado==='ongoing' ? 'bg-blue-600' : 'bg-emerald-600')">
                    </div>
                  </div>
                  <span class="font-semibold text-neutral-900 text-sm" x-text="g._label"></span>
                </div>
              </td>
              <td class="px-3 py-2.5 text-right hidden sm:table-cell">
                <button type="button"
                        class="inline-flex items-center justify-center gap-2 px-4 h-9 rounded-full text-white bg-gradient-to-tr from-brand to-brand-dark shadow-sm hover:shadow-md"
                        @click.stop="join(g)">
                  <i class="fa-solid fa-door-open"></i>
                  <span class="txt" x-text="g._tipo==='privado' ? 'Entrar' : 'Unirse'"></span>
                </button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- Form “silencioso” para unirse -->
    <form id="joinForm" method="POST" action="{{ url_for('grupos.unirse_grupo') }}" class="hidden">
      <input type="hidden" name="codigo_grupo" x-model="join_code">
      <input type="hidden" name="contrasena_grupo" x-model="join_pass">
    </form>

    <!-- Modal contraseña -->
    <div x-show="modalOpen" x-transition.opacity
         class="fixed inset-0 z-50 grid place-items-center p-4 bg-black/45">
      <div @click.outside="modalOpen=false"
           class="w-full max-w-md bg-white rounded-2xl border border-rose-100 shadow-2xl p-5">
        <h3 class="text-lg font-extrabold mb-1">
          <i class="fa-solid fa-lock"></i> Este grupo es privado
        </h3>
        <p class="text-sm text-neutral-600 mb-3">
          Introduce la contraseña para <b x-text="modal_group"></b>
        </p>
        <label class="block font-semibold text-sm mb-1" for="pwInput">Contraseña</label>
        <input id="pwInput" type="password" x-model="join_pass"
               class="w-full h-11 px-4 rounded-full border border-neutral-200 bg-white focus:outline-none focus:ring-4 focus:ring-rose-300"
               placeholder="••••••••" autocomplete="off" />
        <div class="mt-4 flex justify-end gap-2">
          <button type="button" @click="modalOpen=false"
                  class="inline-flex items-center justify-center px-4 h-10 rounded-full border border-rose-100 bg-white hover:bg-neutral-50">
            Cancelar
          </button>
          <button type="button" @click="confirmJoin()"
                  class="inline-flex items-center justify-center gap-2 px-5 h-10 rounded-full text-white bg-gradient-to-tr from-brand to-brand-dark">
            <i class="fa-solid fa-door-open"></i> Unirse
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
function unirseGrupo(){
  const URL_BUSCAR = "{{ url_for('grupos.buscar_grupos') }}";

  const debounce = (fn, d=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); }; };
  const clampPct = (n)=> Math.max(0, Math.min(100, Number(n||0)));

  return {
    // estado UI
    state: 'loading', // loading | ok | error
    base: [],
    rows: [],

    // filtros
    f_q: '',
    f_tipo: '',
    f_sort: 'miembros_desc',
    applyDebounced: debounce(function(){ this.apply(); }, 200),

    // join
    join_code: '',
    join_pass: '',
    modalOpen: false,
    modal_group: '',

    // init
    async init(){
      try{
        const res = await fetch(URL_BUSCAR, { headers: { 'Accept':'application/json' }});
        const data = await res.json();
        this.base = (data.items || []).map(g => ({
          ...g,
          _tipo: (g.tipo || (g.requiere_password ? 'privado' : 'publico')) || 'publico',
          _miem: Number(g.miembros ?? 0),
          _dur : (g.duracion_dias != null) ? Number(g.duracion_dias) : Infinity,
          _label: g.progreso_label ?? (g.duracion_dias == null ? `${g.dias_transcurridos || 0} d · ∞` : `${g.dias_restantes ?? ''} d`),
          _estado: g.estado_temp || ((g.dias_restantes===0) ? 'done' : 'ongoing'),
          _pct: clampPct(g.progreso_pct)
        }));
        this.state = 'ok';
        this.apply();
      }catch(e){
        console.error(e);
        this.state = 'error';
      }
    },

    apply(){
      let arr = this.base.slice();

      // búsqueda
      const q = this.f_q.trim().toLowerCase();
      if(q) arr = arr.filter(g => (g.codigo||'').toString().toLowerCase().includes(q));

      // tipo
      if(this.f_tipo) arr = arr.filter(g => g._tipo === this.f_tipo);

      // orden
      const cmp = {
        'miembros_desc': (a,b)=> b._miem - a._miem,
        'miembros_asc' : (a,b)=> a._miem - b._miem,
        'duracion_asc' : (a,b)=> a._dur - b._dur,
        'duracion_desc': (a,b)=> b._dur - a._dur,
      }[this.f_sort] || ((a,b)=> b._miem - a._miem);

      arr.sort(cmp);
      this.rows = arr;
    },

    onRowClick(ev, g){
      // en móvil, toda la fila sirve (pero evitamos doble submit con el botón)
      if (window.innerWidth >= 640) return;
      this.join(g);
    },

    join(g){
      if(g._tipo === 'privado'){
        this.modal_group = g.codigo;
        this.join_code = g.codigo;
        this.join_pass = '';
        this.modalOpen = true;
        this.$nextTick(()=>{ document.getElementById('pwInput')?.focus(); });
      } else {
        this.join_code = g.codigo;
        this.join_pass = '';
        document.getElementById('joinForm').submit();
      }
    },

    confirmJoin(){
      if(!this.join_pass){ return; }
      document.getElementById('joinForm').submit();
    }
  }
}
</script>
{% endblock %}
